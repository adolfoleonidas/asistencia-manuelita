<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel de Control - Manuelita</title>
    <meta name="theme-color" content="#16a34a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#16a34a;--primary-dark:#15803d;--primary-light:#dcfce7;--success:#059669;--success-light:#d1fae5;--warning:#d97706;--warning-light:#fef3c7;--error:#dc2626;--error-light:#fee2e2;--info:#0284c7;--info-light:#e0f2fe;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;--gray-800:#1f2937;--gray-900:#111827;--sidebar-w:260px;--header-h:70px;--radius:12px;--radius-sm:8px}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'Inter',-apple-system,sans-serif;background:var(--gray-100);color:var(--gray-800);line-height:1.5}
        .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,var(--primary-light) 0%,var(--gray-100) 100%)}
        .login-card{background:#fff;border-radius:var(--radius);box-shadow:0 20px 60px rgba(0,0,0,.1);width:100%;max-width:420px;overflow:hidden}
        .login-header{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:#fff;padding:40px 30px;text-align:center}
        .login-logo{width:80px;height:80px;border-radius:var(--radius-sm);object-fit:contain;margin:0 auto 16px;display:block;background:#fff;padding:8px}
        .login-header h1{font-size:24px;font-weight:800;margin-bottom:4px}
        .login-header p{opacity:.9;font-size:14px}
        .login-body{padding:30px}
        .login-form .form-group{margin-bottom:20px}
        .login-form label{display:block;font-size:14px;font-weight:600;color:var(--gray-700);margin-bottom:8px}
        .login-form input{width:100%;padding:14px 16px;border:2px solid var(--gray-200);border-radius:var(--radius-sm);font-family:inherit;font-size:15px;transition:all .2s}
        .login-form input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px var(--primary-light)}
        .login-form input::placeholder{color:var(--gray-400)}
        .login-btn{width:100%;padding:16px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:10px}
        .login-btn:hover{background:var(--primary-dark)}
        .login-btn:disabled{opacity:.6;cursor:not-allowed}
        .login-error{background:var(--error-light);color:var(--error);padding:12px 16px;border-radius:var(--radius-sm);font-size:14px;margin-bottom:20px;display:none}
        .login-error.show{display:block}
        .login-footer{text-align:center;padding:20px;border-top:1px solid var(--gray-200);font-size:13px;color:var(--gray-500)}
        .app{display:none;min-height:100vh}
        .app.show{display:flex}
        .sidebar{width:var(--sidebar-w);background:#fff;border-right:1px solid var(--gray-200);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform .3s}
        .sidebar-header{padding:20px;border-bottom:1px solid var(--gray-200);display:flex;align-items:center;gap:12px}
        .sidebar-logo{width:44px;height:44px;border-radius:var(--radius-sm);object-fit:contain;background:#fff;padding:4px;border:1px solid var(--gray-200)}
        .sidebar-brand h1{font-size:18px;font-weight:700;color:var(--gray-900)}
        .sidebar-brand span{font-size:12px;color:var(--gray-500)}
        .sidebar-nav{flex:1;padding:16px 12px;overflow-y:auto}
        .nav-section{margin-bottom:24px}
        .nav-section-title{font-size:11px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px;padding:0 12px;margin-bottom:8px}
        .nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:var(--radius-sm);color:var(--gray-600);text-decoration:none;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s;margin-bottom:4px}
        .nav-item:hover{background:var(--gray-100);color:var(--gray-900)}
        .nav-item.active{background:var(--primary-light);color:var(--primary)}
        .nav-item svg{width:20px;height:20px;flex-shrink:0}
        .nav-item .badge{margin-left:auto;background:var(--primary);color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:10px}
        .nav-item.hidden{display:none}
        .sidebar-footer{padding:16px;border-top:1px solid var(--gray-200)}
        .user-info{display:flex;align-items:center;gap:12px;padding:12px;background:var(--gray-50);border-radius:var(--radius-sm);margin-bottom:12px}
        .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary-light);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:var(--primary)}
        .user-details{flex:1;min-width:0}
        .user-name{font-size:14px;font-weight:600;color:var(--gray-900);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .user-role{font-size:12px;color:var(--gray-500)}
        .user-role.super{color:var(--primary);font-weight:600}
        .sync-status{display:flex;align-items:center;gap:8px;padding:12px;background:var(--gray-50);border-radius:var(--radius-sm);font-size:13px;color:var(--gray-600)}
        .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--success)}
        .sync-dot.offline{background:var(--warning)}
        .logout-btn{width:100%;padding:10px;background:transparent;color:var(--gray-600);border:1px solid var(--gray-300);border-radius:var(--radius-sm);font-family:inherit;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;margin-top:12px;display:flex;align-items:center;justify-content:center;gap:8px}
        .logout-btn:hover{background:var(--error-light);color:var(--error);border-color:var(--error)}
        .main{flex:1;margin-left:var(--sidebar-w);display:flex;flex-direction:column}
        .header{height:var(--header-h);background:#fff;border-bottom:1px solid var(--gray-200);display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:50}
        .header-left{display:flex;align-items:center;gap:16px}
        .menu-toggle{display:none;width:40px;height:40px;border:none;background:var(--gray-100);border-radius:var(--radius-sm);cursor:pointer;align-items:center;justify-content:center}
        .page-title{font-size:20px;font-weight:700;color:var(--gray-900)}
        .header-right{display:flex;align-items:center;gap:12px}
        .header-datetime{font-size:14px;color:var(--gray-500);display:flex;align-items:center;gap:8px}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--primary-dark)}
        .btn-secondary{background:#fff;color:var(--gray-700);border:1px solid var(--gray-300)}
        .btn-secondary:hover{background:var(--gray-50)}
        .btn-danger{background:var(--error);color:#fff}
        .btn-success{background:var(--success);color:#fff}
        .btn-sm{padding:6px 12px;font-size:13px}
        .content{flex:1;padding:24px;overflow-y:auto}
        .page{display:none;animation:fadeIn .3s}
        .page.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:24px}
        .stat-card{background:#fff;border-radius:var(--radius);padding:20px;border:1px solid var(--gray-200)}
        .stat-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
        .stat-card-icon{width:44px;height:44px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px}
        .stat-card-icon.green{background:var(--primary-light)}
        .stat-card-icon.blue{background:var(--info-light)}
        .stat-card-icon.yellow{background:var(--warning-light)}
        .stat-card-icon.red{background:var(--error-light)}
        .stat-card-value{font-size:32px;font-weight:800;color:var(--gray-900);line-height:1;margin-bottom:4px}
        .stat-card-label{font-size:14px;color:var(--gray-500)}
        .dashboard-grid{display:grid;grid-template-columns:2fr 1fr;gap:24px}
        .card{background:#fff;border-radius:var(--radius);border:1px solid var(--gray-200);overflow:hidden}
        .card-header{padding:16px 20px;border-bottom:1px solid var(--gray-200);display:flex;align-items:center;justify-content:space-between}
        .card-header h2{font-size:16px;font-weight:600;color:var(--gray-900);display:flex;align-items:center;gap:8px}
        .card-body{padding:20px}
        .card-body.no-padding{padding:0}
        .activity-list{list-style:none}
        .activity-item{display:flex;align-items:center;gap:12px;padding:12px 20px;border-bottom:1px solid var(--gray-100);transition:background .2s}
        .activity-item:last-child{border-bottom:none}
        .activity-item:hover{background:var(--gray-50)}
        .activity-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
        .activity-icon.entrada{background:var(--success-light)}
        .activity-icon.salida{background:var(--info-light)}
        .activity-content{flex:1;min-width:0}
        .activity-name{font-weight:600;color:var(--gray-900);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .activity-detail{font-size:13px;color:var(--gray-500)}
        .activity-time{font-size:13px;color:var(--gray-400);font-weight:500;white-space:nowrap}
        .quick-stats{display:flex;flex-direction:column;gap:16px}
        .quick-stat{display:flex;align-items:center;justify-content:space-between;padding:16px;background:var(--gray-50);border-radius:var(--radius-sm)}
        .quick-stat-label{font-size:14px;color:var(--gray-600)}
        .quick-stat-value{font-size:18px;font-weight:700;color:var(--gray-900)}
        .table-controls{display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
        .search-box{flex:1;min-width:200px;position:relative}
        .search-box input{width:100%;padding:10px 16px 10px 40px;border:1px solid var(--gray-300);border-radius:var(--radius-sm);font-family:inherit;font-size:14px;transition:all .2s}
        .search-box input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
        .search-box svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--gray-400);width:18px;height:18px}
        .filter-group{display:flex;gap:8px;flex-wrap:wrap}
        .filter-group input,.filter-group select{padding:10px 12px;border:1px solid var(--gray-300);border-radius:var(--radius-sm);font-family:inherit;font-size:14px;background:#fff}
        .table-container{overflow-x:auto;border:1px solid var(--gray-200);border-radius:var(--radius)}
        table{width:100%;border-collapse:collapse}
        th,td{padding:12px 16px;text-align:left}
        th{background:var(--gray-50);font-size:12px;font-weight:600;color:var(--gray-500);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--gray-200)}
        td{font-size:14px;color:var(--gray-700);border-bottom:1px solid var(--gray-100)}
        tr:last-child td{border-bottom:none}
        tr:hover td{background:var(--gray-50)}
        .badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
        .badge.entrada{background:var(--success-light);color:var(--success)}
        .badge.salida{background:var(--info-light);color:var(--info)}
        .badge.super_admin{background:var(--primary-light);color:var(--primary)}
        .badge.admin{background:var(--info-light);color:var(--info)}
        .action-btns{display:flex;gap:8px;flex-wrap:wrap}
        .empty-state{text-align:center;padding:60px 20px;color:var(--gray-500)}
        .empty-state h3{font-size:16px;font-weight:600;color:var(--gray-700);margin-bottom:8px}
        .puntos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}
        .punto-card{background:#fff;border:1px solid var(--gray-200);border-radius:var(--radius);padding:20px;text-align:center}
        .punto-card h3{font-size:16px;font-weight:600;color:var(--gray-900);margin-bottom:16px}
        .punto-qr{background:#fff;padding:16px;border-radius:var(--radius-sm);display:inline-block;margin-bottom:16px;border:1px solid var(--gray-200)}
        .punto-url{font-size:11px;color:var(--gray-500);word-break:break-all;margin-bottom:16px;padding:12px;background:var(--gray-50);border-radius:var(--radius-sm);font-family:monospace}
        .punto-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
        .config-section{background:#fff;border:1px solid var(--gray-200);border-radius:var(--radius);margin-bottom:20px}
        .config-section-header{padding:16px 20px;border-bottom:1px solid var(--gray-200)}
        .config-section-header h3{font-size:16px;font-weight:600;color:var(--gray-900)}
        .config-section-header p{font-size:13px;color:var(--gray-500);margin-top:4px}
        .config-section-body{padding:20px}
        .config-row{display:flex;align-items:center;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--gray-100);flex-wrap:wrap;gap:12px}
        .config-row:last-child{border-bottom:none}
        .config-label{font-size:14px;font-weight:500;color:var(--gray-700)}
        .config-label span{display:block;font-size:13px;font-weight:400;color:var(--gray-500);margin-top:2px}
        .config-input{width:280px;padding:10px 12px;border:1px solid var(--gray-300);border-radius:var(--radius-sm);font-family:inherit;font-size:14px}
        .config-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
        .config-input.full{width:100%}
        .toggle{position:relative;display:inline-block;width:50px;height:28px}
        .toggle input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;inset:0;background:var(--gray-300);border-radius:28px;transition:.3s}
        .toggle-slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}
        .toggle input:checked+.toggle-slider{background:var(--primary)}
        .toggle input:checked+.toggle-slider:before{transform:translateX(22px)}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:200;padding:20px}
        .modal.show{display:flex}
        .modal-content{background:#fff;border-radius:var(--radius);width:100%;max-width:500px;max-height:90vh;overflow:hidden;animation:modalIn .3s;display:flex;flex-direction:column}
        @keyframes modalIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
        .modal-header{padding:20px;border-bottom:1px solid var(--gray-200);display:flex;align-items:center;justify-content:space-between}
        .modal-header h2{font-size:18px;font-weight:600}
        .modal-close{width:32px;height:32px;border:none;background:var(--gray-100);border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--gray-500);transition:all .2s}
        .modal-close:hover{background:var(--error-light);color:var(--error)}
        .modal-body{padding:20px;overflow-y:auto;flex:1}
        .modal-footer{padding:16px 20px;border-top:1px solid var(--gray-200);display:flex;justify-content:flex-end;gap:12px}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;font-size:14px;font-weight:500;color:var(--gray-700);margin-bottom:8px}
        .form-group input,.form-group select{width:100%;padding:12px;border:1px solid var(--gray-300);border-radius:var(--radius-sm);font-family:inherit;font-size:14px}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
        .form-group small{display:block;margin-top:6px;font-size:12px;color:var(--gray-500)}
        .toast{position:fixed;bottom:24px;right:24px;padding:16px 20px;border-radius:var(--radius-sm);font-size:14px;font-weight:500;display:flex;align-items:center;gap:12px;z-index:300;opacity:0;transform:translateY(20px);transition:all .3s;box-shadow:0 10px 40px rgba(0,0,0,.2)}
        .toast.show{opacity:1;transform:translateY(0)}
        .toast.success{background:var(--success);color:#fff}
        .toast.error{background:var(--error);color:#fff}
        .toast.warning{background:var(--warning);color:#fff}
        .loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.9);display:none;align-items:center;justify-content:center;z-index:400}
        .loading-overlay.show{display:flex}
        .spinner{width:40px;height:40px;border:3px solid var(--gray-200);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .alert{padding:16px;border-radius:var(--radius-sm);margin-bottom:20px;font-size:14px}
        .alert-info{background:var(--info-light);color:var(--info);border:1px solid var(--info)}
        .alert-warning{background:var(--warning-light);color:#92400e;border:1px solid var(--warning)}
        @media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}.dashboard-grid{grid-template-columns:1fr}}
        @media(max-width:768px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.main{margin-left:0}.menu-toggle{display:flex}.stats-grid{grid-template-columns:1fr 1fr}.header-datetime{display:none}.table-controls{flex-direction:column;align-items:stretch}.search-box{min-width:100%}.config-input{width:100%}.content{padding:16px}.header{padding:0 16px}.btn{padding:10px 14px;font-size:13px}.puntos-grid{grid-template-columns:1fr}}
        @media(max-width:480px){.stats-grid{grid-template-columns:1fr}.stat-card{padding:16px}.stat-card-value{font-size:24px}.action-btns{flex-direction:column}.action-btns .btn{width:100%}.filter-group{width:100%}.filter-group input,.filter-group select{flex:1}.login-body{padding:20px}.login-header{padding:30px 20px}.modal-content{margin:10px}.toast{left:16px;right:16px;transform:translateX(0) translateY(100px)}.toast.show{transform:translateX(0) translateY(0)}}
        .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;display:none}
        .overlay.show{display:block}
        /* Column config modal */
        .col-config-list{list-style:none;padding:0;margin:0;max-height:50vh;overflow-y:auto}
        .col-config-item{display:flex;align-items:center;gap:12px;padding:10px 12px;margin-bottom:6px;background:var(--gray-50);border:1px solid var(--gray-200);border-radius:var(--radius-sm);cursor:grab;user-select:none;transition:background .15s,box-shadow .15s}
        .col-config-item:active{cursor:grabbing}
        .col-config-item.dragging{opacity:.5;background:var(--primary-light);box-shadow:0 4px 12px rgba(0,0,0,.15)}
        .col-config-item.drag-over{border-color:var(--primary);background:var(--primary-light)}
        .drag-handle{color:var(--gray-400);flex-shrink:0;display:flex;align-items:center}
        .col-toggle{margin-left:auto;flex-shrink:0}
        .col-config-item label{flex:1;font-size:14px;font-weight:500;color:var(--gray-700);cursor:pointer}
        .btn-columns{gap:6px}
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <img src="https://mrqfeynhafxtfjqmjaxb.supabase.co/storage/v1/object/public/driver-images/drivers/1766979760638-y186di.jpg" alt="Manuelita" class="login-logo">
                <h1>MANUELITA</h1>
                <p>Panel de Control de Asistencia</p>
            </div>
            <div class="login-body">
                <div class="login-error" id="loginError">Usuario o contrase√±a incorrectos</div>
                <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Usuario o Email</label>
                        <input type="text" id="loginEmail" placeholder="admin o admin@empresa.com" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a</label>
                        <input type="password" id="loginPassword" placeholder="Ingresa tu contrase√±a" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="login-btn" id="loginBtn">
                        <span>Iniciar Sesi√≥n</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                    </button>
                </form>
            </div>
            <div class="login-footer">
                Sistema de Control de Asistencia v3.0
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app" id="mainApp">
        <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://mrqfeynhafxtfjqmjaxb.supabase.co/storage/v1/object/public/driver-images/drivers/1766979760638-y186di.jpg" alt="Manuelita" class="sidebar-logo">
                <div class="sidebar-brand"><h1>Manuelita</h1><span>Control de Asistencia</span></div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <a class="nav-item active" onclick="showPage('dashboard',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                        Dashboard
                    </a>
                    <a class="nav-item" onclick="showPage('asistencias',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        Asistencias
                    </a>
                    <a class="nav-item" onclick="showPage('trabajadores',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Trabajadores<span class="badge" id="badgeTrabajadores">0</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Herramientas</div>
                    <a class="nav-item" onclick="showPage('puntos',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 7h.01M7 12h.01M7 17h.01M12 7h.01M12 12h.01M12 17h.01M17 7h.01M17 12h.01M17 17h.01"/></svg>
                        Puntos QR
                    </a>
                    <a class="nav-item" id="navUsuarios" onclick="showPage('usuarios',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                        Usuarios Admin
                    </a>
                    <a class="nav-item" id="navAuditLog" onclick="showPage('audit',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        Registro de Actividades
                    </a>
                    <a class="nav-item" id="navConfiguracion" onclick="showPage('configuracion',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                        Configuraci√≥n
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role" id="userRole">Administrador</div>
                        <div style="font-size:11px;color:var(--gray-400);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="userEmail"></div>
                    </div>
                </div>
                <div class="sync-status"><span class="sync-dot" id="syncDot"></span><span id="syncText">Conectado</span></div>
                <button class="logout-btn" onclick="handleLogout()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Cerrar Sesi√≥n
                </button>
            </div>
        </aside>
        <main class="main">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                <div class="header-right">
                    <div class="header-datetime" id="headerDatetime"></div>
                    <button class="btn btn-secondary" onclick="syncData()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg><span class="btn-text">Sincronizar</span></button>
                </div>
            </header>
            <div class="content">
                <!-- Dashboard -->
                <div class="page active" id="page-dashboard">
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon green"><i data-lucide="users" style="width:24px;height:24px;color:var(--primary)"></i></div></div><div class="stat-card-value" id="statPresentes">0</div><div class="stat-card-label">Presentes ahora</div></div>
                        <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon blue"><i data-lucide="log-in" style="width:24px;height:24px;color:var(--info)"></i></div></div><div class="stat-card-value" id="statEntradas">0</div><div class="stat-card-label">Entradas hoy</div></div>
                        <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon yellow"><i data-lucide="log-out" style="width:24px;height:24px;color:var(--warning)"></i></div></div><div class="stat-card-value" id="statSalidas">0</div><div class="stat-card-label">Salidas hoy</div></div>
                        <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon red"><i data-lucide="bar-chart-3" style="width:24px;height:24px;color:var(--error)"></i></div></div><div class="stat-card-value" id="statTotal">0</div><div class="stat-card-label">Total registros</div></div>
                    </div>
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header"><h2><i data-lucide="bar-chart-2" style="width:18px;height:18px"></i> Asistencia Semanal</h2></div>
                            <div class="card-body"><div style="position:relative;height:250px"><canvas id="chartAsistencia"></canvas></div></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h2><i data-lucide="pie-chart" style="width:18px;height:18px"></i> Resumen</h2></div>
                            <div class="card-body">
                                <div class="quick-stats">
                                    <div class="quick-stat"><span class="quick-stat-label">Trabajadores</span><span class="quick-stat-value" id="quickTrabajadores">0</span></div>
                                    <div class="quick-stat"><span class="quick-stat-label">Asistencia hoy</span><span class="quick-stat-value" id="quickAsistencia">0%</span></div>
                                    <div class="quick-stat"><span class="quick-stat-label">Puntos activos</span><span class="quick-stat-value" id="quickPuntos">0</span></div>
                                </div>
                                <div style="position:relative;height:180px;margin-top:20px"><canvas id="chartTipos"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="margin-top:24px">
                        <div class="card-header"><h2><i data-lucide="activity" style="width:18px;height:18px"></i> Actividad Reciente</h2><button class="btn btn-sm btn-secondary" onclick="showPage('asistencias',document.querySelector('[onclick*=asistencias]'))">Ver todo</button></div>
                        <div class="card-body no-padding"><ul class="activity-list" id="activityList"></ul></div>
                    </div>
                    <div class="card" style="margin-top:24px;display:none" id="dashboardAuditCard">
                        <div class="card-header"><h2><i data-lucide="shield" style="width:18px;height:18px"></i> Actividad de Admins (Hoy)</h2><button class="btn btn-sm btn-secondary" onclick="showPage('audit',document.querySelector('[onclick*=audit]'))">Ver todo</button></div>
                        <div class="card-body no-padding"><ul class="activity-list" id="dashboardAuditList"></ul></div>
                    </div>
                </div>
                <!-- Trabajadores -->
                <div class="page" id="page-trabajadores">
                    <div class="table-controls">
                        <div class="search-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><input type="text" placeholder="Buscar trabajador..." id="searchTrabajador" oninput="filterTrabajadores()"></div>
                        <button class="btn btn-primary" onclick="openModalTrabajador()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><span class="btn-text">Agregar</span></button>
                        <button class="btn btn-secondary" onclick="exportTrabajadores()">üìÑ <span class="btn-text">Exportar</span></button>
                        <button class="btn btn-secondary btn-columns" onclick="openColumnConfigModal('trabajadores')"><i data-lucide="columns" style="width:16px;height:16px"></i> <span class="btn-text">Columnas</span></button>
                    </div>
                    <div class="table-container"><table><thead id="theadTrabajadores"></thead><tbody id="tablaTrabajadores"></tbody></table></div>
                </div>
                <!-- Asistencias -->
                <div class="page" id="page-asistencias">
                    <div class="table-controls" style="flex-wrap:wrap;gap:12px">
                        <div class="search-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><input type="text" placeholder="Buscar..." id="searchAsistencia" oninput="filterAsistencias()"></div>
                        <div class="filter-group">
                            <input type="date" id="filterFechaInicio" onchange="filterAsistencias()" title="Fecha inicio">
                            <span style="color:var(--gray-400)">a</span>
                            <input type="date" id="filterFechaFin" onchange="filterAsistencias()" title="Fecha fin">
                            <select id="filterTipo" onchange="filterAsistencias()"><option value="">Todos</option><option value="ENTRADA">Entradas</option><option value="SALIDA">Salidas</option></select>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-secondary" id="btnViewToggle" onclick="toggleAsistenciasView()"><i data-lucide="list" style="width:16px;height:16px" id="btnViewToggleIcon"></i> <span class="btn-text" id="btnViewToggleText">Agrupada</span></button>
                            <button class="btn btn-secondary" onclick="exportAsistenciasExcel()"><i data-lucide="file-spreadsheet" style="width:16px;height:16px"></i> <span class="btn-text">Excel</span></button>
                            <button class="btn btn-primary" onclick="exportAsistencias()"><i data-lucide="file-text" style="width:16px;height:16px"></i> <span class="btn-text">PDF</span></button>
                            <button class="btn btn-secondary btn-columns" onclick="openColumnConfigModal('asistencias')"><i data-lucide="columns" style="width:16px;height:16px"></i> <span class="btn-text">Columnas</span></button>
                        </div>
                    </div>
                    <div class="table-container"><table><thead id="theadAsistencias"></thead><tbody id="tablaAsistencias"></tbody></table></div>
                </div>
                <!-- Puntos QR -->
                <div class="page" id="page-puntos">
                    <div class="alert alert-info">
                        ‚ÑπÔ∏è <strong>¬øC√≥mo funciona?</strong> Cada punto genera un c√≥digo QR. Imprime el QR y col√≥calo en la entrada. Los trabajadores lo escanean con su celular para marcar asistencia.
                    </div>
                    <div class="table-controls"><button class="btn btn-primary" id="btnAgregarPunto" onclick="openModalPunto()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><span class="btn-text">Agregar Punto</span></button></div>
                    <div class="puntos-grid" id="puntosGrid"></div>
                </div>
                <!-- Usuarios Admin -->
                <div class="page" id="page-usuarios">
                    <div class="table-controls">
                        <div class="search-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><input type="text" placeholder="Buscar usuario..." id="searchUsuario" oninput="filterUsuarios()"></div>
                        <button class="btn btn-primary" id="btnAgregarAdmin" onclick="openModalUsuario()" style="display:none"><i data-lucide="user-plus" style="width:16px;height:16px"></i> Agregar Admin</button>
                        <button class="btn btn-secondary btn-columns" onclick="openColumnConfigModal('usuarios')"><i data-lucide="columns" style="width:16px;height:16px"></i> <span class="btn-text">Columnas</span></button>
                    </div>
                    <div class="table-container"><table><thead id="theadUsuarios"></thead><tbody id="tablaUsuarios"></tbody></table></div>
                </div>
                <!-- Registro de Actividades -->
                <div class="page" id="page-audit">
                    <div class="stats-grid" id="auditStatsGrid" style="margin-bottom:24px">
                        <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon blue"><i data-lucide="log-in" style="width:24px;height:24px;color:var(--info)"></i></div></div><div class="stat-card-value" id="auditStatLogins">0</div><div class="stat-card-label">Logins hoy</div></div>
                        <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon green"><i data-lucide="activity" style="width:24px;height:24px;color:var(--primary)"></i></div></div><div class="stat-card-value" id="auditStatAcciones">0</div><div class="stat-card-label">Acciones hoy</div></div>
                        <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon yellow"><i data-lucide="users" style="width:24px;height:24px;color:var(--warning)"></i></div></div><div class="stat-card-value" id="auditStatUsuarios">0</div><div class="stat-card-label">Usuarios activos hoy</div></div>
                        <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon red"><i data-lucide="shield" style="width:24px;height:24px;color:var(--error)"></i></div></div><div class="stat-card-value" id="auditStatTotal">0</div><div class="stat-card-label">Total registros</div></div>
                    </div>
                    <div class="card" style="margin-bottom:24px">
                        <div class="card-header"><h2><i data-lucide="clock" style="width:18px;height:18px"></i> Ultimo Acceso por Usuario</h2></div>
                        <div class="card-body no-padding">
                            <div class="table-container"><table><thead><tr><th>Usuario</th><th>Email</th><th>Rol</th><th>Ultimo Login</th><th>Logins Hoy</th><th>Total Acciones Hoy</th></tr></thead><tbody id="tablaAuditUsuarios"></tbody></table></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2><i data-lucide="list" style="width:18px;height:18px"></i> Historial de Actividades</h2><div style="display:flex;gap:8px;align-items:center"><select id="auditFilterAccion" onchange="filterAuditLog()" style="padding:6px 10px;border:1px solid var(--gray-200);border-radius:8px;font-size:13px"><option value="">Todas las acciones</option><option value="LOGIN">Login</option><option value="LOGOUT">Logout</option><option value="NAVIGATE">Navegaci&oacute;n</option><option value="CREATE">Crear</option><option value="UPDATE">Actualizar</option><option value="DELETE">Eliminar</option><option value="EXPORT">Exportar</option><option value="CONFIG">Configuraci&oacute;n</option></select><select id="auditFilterUsuario" onchange="filterAuditLog()" style="padding:6px 10px;border:1px solid var(--gray-200);border-radius:8px;font-size:13px"><option value="">Todos los usuarios</option></select><input type="date" id="auditFilterFecha" onchange="filterAuditLog()" style="padding:6px 10px;border:1px solid var(--gray-200);border-radius:8px;font-size:13px"></div></div>
                        <div class="card-body no-padding">
                            <div class="table-container"><table><thead><tr><th>Fecha</th><th>Hora</th><th>Usuario</th><th>Acci&oacute;n</th><th>Detalle</th><th>Secci&oacute;n</th></tr></thead><tbody id="tablaAuditLog"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <!-- Configuraci√≥n -->
                <div class="page" id="page-configuracion">
                    <div class="config-section">
                        <div class="config-section-header"><h3><i data-lucide="key" style="width:20px;height:20px;display:inline;vertical-align:middle"></i> Configuraci√≥n de Supabase</h3><p>Credenciales para conectar con tu proyecto</p></div>
                        <div class="config-section-body">
                            <div class="form-group">
                                <label>Supabase URL</label>
                                <input type="text" class="config-input full" id="configSupabaseUrl" placeholder="https://xxxx.supabase.co">
                            </div>
                            <div class="form-group">
                                <label>Supabase Anon Key</label>
                                <input type="text" class="config-input full" id="configSupabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                            </div>
                            <button class="btn btn-primary" onclick="saveSupabaseConfig()"><i data-lucide="save" style="width:16px;height:16px"></i> Guardar y Reconectar</button>
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-header"><h3><i data-lucide="map-pin" style="width:20px;height:20px;display:inline;vertical-align:middle"></i> Verificaci√≥n GPS</h3><p>Controla si se requiere verificaci√≥n de ubicaci√≥n para marcar asistencia</p></div>
                        <div class="config-section-body">
                            <div class="config-row">
                                <div class="config-label">Activar verificaci√≥n GPS<span>Si est√° desactivado, los empleados pueden marcar desde cualquier lugar</span></div>
                                <label class="toggle">
                                    <input type="checkbox" id="configGpsEnabled" onchange="saveGpsConfig()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-header"><h3><i data-lucide="database" style="width:20px;height:20px;display:inline;vertical-align:middle"></i> Datos</h3><p>Gestiona los datos almacenados</p></div>
                        <div class="config-section-body">
                            <div class="config-row">
                                <div class="config-label">Exportar Backup<span>Descarga todos los datos en JSON</span></div>
                                <button class="btn btn-secondary" onclick="downloadBackup()">‚¨áÔ∏è Descargar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Trabajador -->
    <div class="modal" id="modalTrabajador">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalTrabajadorTitle">Agregar Trabajador</h2><button class="modal-close" onclick="closeModalTrabajador()">‚úï</button></div>
            <div class="modal-body">
                <form id="formTrabajador" onsubmit="saveTrabajador(event)">
                    <input type="hidden" id="editingDni">
                    <div class="form-group"><label>DNI *</label><input type="text" id="inputDni" maxlength="8" pattern="[0-9]{8}" placeholder="8 d√≠gitos" required></div>
                    <div class="form-group"><label>Nombres y Apellidos *</label><input type="text" id="inputNombre" placeholder="Nombre completo" required></div>
                    <div class="form-group"><label>Cargo *</label><input type="text" id="inputCargo" placeholder="Cargo" required></div>
                    <div class="form-group"><label>√Årea *</label><input type="text" id="inputArea" placeholder="√Årea" required></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModalTrabajador()">Cancelar</button><button class="btn btn-primary" onclick="document.getElementById('formTrabajador').requestSubmit()">Guardar</button></div>
        </div>
    </div>

    <!-- Modal Asistencia -->
    <div class="modal" id="modalAsistencia">
        <div class="modal-content">
            <div class="modal-header"><h2>Editar Asistencia</h2><button class="modal-close" onclick="closeModalAsistencia()">‚úï</button></div>
            <div class="modal-body">
                <form id="formAsistencia" onsubmit="saveAsistencia(event)">
                    <input type="hidden" id="editingAsistenciaId">
                    <div class="form-group"><label>Trabajador</label><input type="text" id="inputAsistenciaNombre" disabled></div>
                    <div class="form-group"><label>Fecha *</label><input type="date" id="inputAsistenciaFecha" required></div>
                    <div class="form-group"><label>Hora *</label><input type="time" id="inputAsistenciaHora" step="1" required></div>
                    <div class="form-group"><label>Tipo *</label><select id="inputAsistenciaTipo" required><option value="ENTRADA">ENTRADA</option><option value="SALIDA">SALIDA</option></select></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModalAsistencia()">Cancelar</button><button class="btn btn-primary" onclick="document.getElementById('formAsistencia').requestSubmit()">Guardar</button></div>
        </div>
    </div>

    <!-- Modal Punto -->
    <div class="modal" id="modalPunto">
        <div class="modal-content">
            <div class="modal-header"><h2>Agregar Punto de Marcaci√≥n</h2><button class="modal-close" onclick="closeModalPunto()">‚úï</button></div>
            <div class="modal-body">
                <form id="formPunto" onsubmit="savePunto(event)">
                    <div class="form-group"><label>Nombre del punto *</label><input type="text" id="inputPuntoNombre" placeholder="Ej: Entrada Principal" required></div>
                    <div class="form-group"><label>ID √∫nico *</label><input type="text" id="inputPuntoId" placeholder="Ej: ENTRADA_PRINCIPAL" required><small>Sin espacios, usar guiones bajos (_)</small></div>
                    <div class="form-group"><label>Latitud</label><input type="text" id="inputPuntoLat" placeholder="-14.0678"></div>
                    <div class="form-group"><label>Longitud</label><input type="text" id="inputPuntoLng" placeholder="-75.7286"></div>
                    <div class="form-group"><label>Radio en metros</label><input type="number" id="inputPuntoRadio" value="150"></div>
                    <button type="button" class="btn btn-secondary" onclick="usarMiUbicacionPunto()" style="width:100%"><i data-lucide="locate" style="width:16px;height:16px"></i> Usar mi ubicaci√≥n actual</button>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModalPunto()">Cancelar</button><button class="btn btn-primary" onclick="document.getElementById('formPunto').requestSubmit()">Crear Punto</button></div>
        </div>
    </div>

    <!-- Modal Usuario -->
    <div class="modal" id="modalUsuario">
        <div class="modal-content">
            <div class="modal-header"><h2>Agregar Administrador</h2><button class="modal-close" onclick="closeModalUsuario()">√ó</button></div>
            <div class="modal-body">
                <form id="formUsuario" onsubmit="saveUsuario(event)">
                    <div class="form-group"><label>Email *</label><input type="email" id="inputUserEmail" placeholder="correo@ejemplo.com" required></div>
                    <div class="form-group"><label>Contrase√±a *</label><input type="password" id="inputUserPassword" placeholder="M√≠nimo 6 caracteres" minlength="6" required></div>
                    <div class="form-group"><label>Nombre completo *</label><input type="text" id="inputUserNombre" placeholder="Juan P√©rez" required></div>
                    <div class="form-group"><label>Usuario *</label><input type="text" id="inputUserUsername" placeholder="juanperez" required><small>Sin espacios, en min√∫sculas</small></div>
                    <div class="form-group">
                        <label>Rol *</label>
                        <select id="inputUserRol" required>
                            <option value="admin">Admin (acceso b√°sico)</option>
                            <option value="super_admin">Super Admin (acceso total)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModalUsuario()">Cancelar</button><button class="btn btn-primary" onclick="document.getElementById('formUsuario').requestSubmit()">Crear Usuario</button></div>
        </div>
    </div>

    <!-- Modal Column Config -->
    <div class="modal" id="modalColumnConfig">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalColumnConfigTitle">Configurar Columnas</h2><button class="modal-close" onclick="closeColumnConfigModal()">‚úï</button></div>
            <div class="modal-body">
                <input type="hidden" id="columnConfigTableKey">
                <p style="font-size:13px;color:var(--gray-500);margin-bottom:12px">Arrastra para reordenar. Desmarca para ocultar.</p>
                <ul class="col-config-list" id="colConfigList"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetColumnPrefsFromModal()">Restaurar</button>
                <button class="btn btn-secondary" onclick="closeColumnConfigModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveColumnConfigFromModal()">Guardar</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="loading-overlay" id="loading"><div class="spinner"></div></div>

    <script>
// =====================================================
// ESTADO DE LA APLICACI√ìN
// =====================================================
let state = {
    trabajadores: [],
    asistencias: [],
    puntos: [],
    usuarios: [],
    auditLogs: [],
    currentUser: null,
    columnPrefs: null
};

// =====================================================
// COLUMN DEFINITIONS & PREFERENCES
// =====================================================
const COLUMN_DEFS = {
    trabajadores: [
        { id: 'dni', label: 'DNI', defaultVisible: true,
          renderHtml: t => '<strong>' + escapeHtml(t.dni) + '</strong>',
          renderPdf: t => t.dni,
          renderExcel: t => t.dni },
        { id: 'nombre', label: 'Nombre', defaultVisible: true,
          renderHtml: t => escapeHtml(t.nombre),
          renderPdf: t => t.nombre,
          renderExcel: t => t.nombre },
        { id: 'cargo', label: 'Cargo', defaultVisible: true,
          renderHtml: t => escapeHtml(t.cargo),
          renderPdf: t => t.cargo,
          renderExcel: t => t.cargo },
        { id: 'area', label: '√Årea', defaultVisible: true,
          renderHtml: t => escapeHtml(t.area),
          renderPdf: t => t.area,
          renderExcel: t => t.area }
    ],
    asistencias: [
        { id: 'nombre', label: 'Trabajador', defaultVisible: true,
          renderHtml: a => '<strong>' + escapeHtml(a.nombre) + '</strong>',
          renderPdf: a => a.nombre,
          renderExcel: a => a.nombre },
        { id: 'dni', label: 'DNI', defaultVisible: true,
          renderHtml: a => escapeHtml(a.dni),
          renderPdf: a => a.dni,
          renderExcel: a => a.dni },
        { id: 'cargo', label: 'Cargo', defaultVisible: false,
          renderHtml: a => escapeHtml(a.cargo || '-'),
          renderPdf: a => a.cargo || '-',
          renderExcel: a => a.cargo || '-' },
        { id: 'tipo', label: 'Tipo', defaultVisible: true,
          renderHtml: a => '<span class="badge ' + a.tipo.toLowerCase() + '">' + escapeHtml(a.tipo) + '</span>',
          renderPdf: a => a.tipo,
          renderExcel: a => a.tipo },
        { id: 'fecha', label: 'Fecha', defaultVisible: true,
          renderHtml: a => escapeHtml(a.fecha),
          renderPdf: a => a.fecha,
          renderExcel: a => a.fecha },
        { id: 'hora', label: 'Hora', defaultVisible: true,
          renderHtml: a => escapeHtml(a.hora),
          renderPdf: a => a.hora,
          renderExcel: a => a.hora },
        { id: 'punto', label: 'Punto', defaultVisible: true,
          renderHtml: a => escapeHtml(a.punto || '-'),
          renderPdf: a => a.punto || '-',
          renderExcel: a => a.punto || '-' },
        { id: 'ubicacion', label: 'Ubicaci√≥n', defaultVisible: true,
          renderHtml: a => a.lat ? '<a href="https://maps.google.com/?q=' + a.lat + ',' + a.lng + '" target="_blank" style="color:var(--primary)"><i data-lucide="map-pin" style="width:14px;height:14px"></i></a>' : '-',
          renderPdf: a => a.lat ? a.lat + ',' + a.lng : '-',
          renderExcel: a => a.lat ? a.lat + ',' + a.lng : '-' },
        { id: 'latitud', label: 'Latitud', defaultVisible: false,
          renderHtml: a => a.lat || '-',
          renderPdf: a => a.lat || '-',
          renderExcel: a => a.lat || '-' },
        { id: 'longitud', label: 'Longitud', defaultVisible: false,
          renderHtml: a => a.lng || '-',
          renderPdf: a => a.lng || '-',
          renderExcel: a => a.lng || '-' }
    ],
    asistencias_grouped: [
        { id: 'nombre', label: 'Trabajador', defaultVisible: true,
          renderHtml: a => '<strong>' + escapeHtml(a.nombre) + '</strong>',
          renderPdf: a => a.nombre,
          renderExcel: a => a.nombre },
        { id: 'dni', label: 'DNI', defaultVisible: true,
          renderHtml: a => escapeHtml(a.dni),
          renderPdf: a => a.dni,
          renderExcel: a => a.dni },
        { id: 'cargo', label: 'Cargo', defaultVisible: false,
          renderHtml: a => escapeHtml(a.cargo || '-'),
          renderPdf: a => a.cargo || '-',
          renderExcel: a => a.cargo || '-' },
        { id: 'fecha', label: 'Fecha', defaultVisible: true,
          renderHtml: a => escapeHtml(a.fecha),
          renderPdf: a => a.fecha,
          renderExcel: a => a.fecha },
        { id: 'entrada', label: 'Entrada', defaultVisible: true,
          renderHtml: a => escapeHtml(a.horaEntrada || '\u2014'),
          renderPdf: a => a.horaEntrada || '\u2014',
          renderExcel: a => a.horaEntrada || '\u2014' },
        { id: 'salida', label: 'Salida', defaultVisible: true,
          renderHtml: a => escapeHtml(a.horaSalida || '\u2014'),
          renderPdf: a => a.horaSalida || '\u2014',
          renderExcel: a => a.horaSalida || '\u2014' },
        { id: 'punto', label: 'Punto', defaultVisible: true,
          renderHtml: a => escapeHtml(a.punto || '-'),
          renderPdf: a => a.punto || '-',
          renderExcel: a => a.punto || '-' },
        { id: 'ubicacion', label: 'Ubicaci√≥n', defaultVisible: true,
          renderHtml: a => a.lat ? '<a href="https://maps.google.com/?q=' + a.lat + ',' + a.lng + '" target="_blank" style="color:var(--primary)"><i data-lucide="map-pin" style="width:14px;height:14px"></i></a>' : '-',
          renderPdf: a => a.lat ? a.lat + ',' + a.lng : '-',
          renderExcel: a => a.lat ? a.lat + ',' + a.lng : '-' }
    ],
    usuarios: [
        { id: 'username', label: 'Usuario', defaultVisible: true,
          renderHtml: (u, extra) => '<strong>' + escapeHtml(u.username) + '</strong>' + (extra.isCurrentUser ? ' <span style="color:var(--primary)">(t√∫)</span>' : ''),
          renderPdf: u => u.username,
          renderExcel: u => u.username },
        { id: 'email', label: 'Email', defaultVisible: true,
          renderHtml: u => '<span style="font-size:13px;color:var(--gray-500)">' + escapeHtml(u.email || '-') + '</span>',
          renderPdf: u => u.email || '-',
          renderExcel: u => u.email || '-' },
        { id: 'nombre', label: 'Nombre', defaultVisible: true,
          renderHtml: u => escapeHtml(u.nombre),
          renderPdf: u => u.nombre,
          renderExcel: u => u.nombre },
        { id: 'rol', label: 'Rol', defaultVisible: true,
          renderHtml: u => { const rb = u.rol === 'super_admin' ? 'super_admin' : 'admin'; const rt = u.rol === 'super_admin' ? 'Super Admin' : 'Admin'; return '<span class="badge ' + rb + '">' + rt + '</span>'; },
          renderPdf: u => u.rol === 'super_admin' ? 'Super Admin' : 'Admin',
          renderExcel: u => u.rol === 'super_admin' ? 'Super Admin' : 'Admin' },
        { id: 'fecha_creacion', label: 'Creado', defaultVisible: true,
          renderHtml: u => u.fecha_creacion ? new Date(u.fecha_creacion).toLocaleDateString('es-PE') : '-',
          renderPdf: u => u.fecha_creacion ? new Date(u.fecha_creacion).toLocaleDateString('es-PE') : '-',
          renderExcel: u => u.fecha_creacion ? new Date(u.fecha_creacion).toLocaleDateString('es-PE') : '-' }
    ]
};

function getDefaultColumnPrefs() {
    const prefs = {};
    for (const [tableKey, cols] of Object.entries(COLUMN_DEFS)) {
        prefs[tableKey] = {
            columns: cols.map(c => c.id),
            hidden: cols.filter(c => !c.defaultVisible).map(c => c.id)
        };
    }
    prefs.asistencias.viewMode = 'detailed';
    return prefs;
}

async function loadColumnPrefs() {
    if (!state.currentUser) { state.columnPrefs = getDefaultColumnPrefs(); return; }
    try {
        const { data } = await db.from('system_config').select('value').eq('key', 'col_prefs_' + state.currentUser.id).maybeSingle();
        if (data && data.value) {
            const saved = JSON.parse(data.value);
            const defaults = getDefaultColumnPrefs();
            // Reconcile: add any new columns from COLUMN_DEFS that aren't in saved prefs
            for (const [tableKey, cols] of Object.entries(COLUMN_DEFS)) {
                if (!saved[tableKey]) { saved[tableKey] = defaults[tableKey]; continue; }
                const allIds = cols.map(c => c.id);
                const savedIds = saved[tableKey].columns || [];
                // Add missing columns at the end
                allIds.forEach(id => { if (!savedIds.includes(id)) { saved[tableKey].columns.push(id); if (!cols.find(c => c.id === id).defaultVisible) saved[tableKey].hidden.push(id); } });
                // Remove columns that no longer exist in COLUMN_DEFS
                saved[tableKey].columns = saved[tableKey].columns.filter(id => allIds.includes(id));
                saved[tableKey].hidden = (saved[tableKey].hidden || []).filter(id => allIds.includes(id));
            }
            // Ensure viewMode exists for asistencias
            if (saved.asistencias && !saved.asistencias.viewMode) saved.asistencias.viewMode = 'detailed';
            state.columnPrefs = saved;
        } else {
            state.columnPrefs = getDefaultColumnPrefs();
        }
    } catch (e) {
        state.columnPrefs = getDefaultColumnPrefs();
    }
}

async function saveColumnPrefs() {
    if (!state.currentUser || !state.columnPrefs) return;
    try {
        await db.from('system_config').upsert({ key: 'col_prefs_' + state.currentUser.id, value: JSON.stringify(state.columnPrefs) });
    } catch (e) {
        console.error('Error saving column prefs:', e);
    }
}

function getVisibleColumns(tableKey) {
    if (!state.columnPrefs || !state.columnPrefs[tableKey]) return COLUMN_DEFS[tableKey].filter(c => c.defaultVisible);
    const prefs = state.columnPrefs[tableKey];
    const hidden = prefs.hidden || [];
    return prefs.columns.filter(id => !hidden.includes(id)).map(id => COLUMN_DEFS[tableKey].find(c => c.id === id)).filter(Boolean);
}

function getOrderedColumns(tableKey) {
    if (!state.columnPrefs || !state.columnPrefs[tableKey]) return COLUMN_DEFS[tableKey].map(c => ({ ...c, visible: c.defaultVisible }));
    const prefs = state.columnPrefs[tableKey];
    const hidden = prefs.hidden || [];
    return prefs.columns.map(id => {
        const def = COLUMN_DEFS[tableKey].find(c => c.id === id);
        return def ? { ...def, visible: !hidden.includes(id) } : null;
    }).filter(Boolean);
}

function renderTableHead(tableKey, hasActions) {
    const cols = getVisibleColumns(tableKey);
    let html = '<tr>';
    cols.forEach(c => { html += '<th>' + escapeHtml(c.label) + '</th>'; });
    if (hasActions) html += '<th>Acciones</th>';
    html += '</tr>';
    return html;
}

function renderTableRow(tableKey, item, actionsHtml, extra) {
    const cols = getVisibleColumns(tableKey);
    let html = '<tr>';
    cols.forEach(c => { html += '<td>' + c.renderHtml(item, extra || {}) + '</td>'; });
    if (actionsHtml !== undefined) html += '<td>' + actionsHtml + '</td>';
    html += '</tr>';
    return html;
}

function renderAllTableHeads() {
    const isSA = isSuperAdmin();
    const thTrab = document.getElementById('theadTrabajadores');
    const thAsis = document.getElementById('theadAsistencias');
    const thUsu = document.getElementById('theadUsuarios');
    if (thTrab) thTrab.innerHTML = renderTableHead('trabajadores', isSA);
    if (thAsis) thAsis.innerHTML = renderTableHead(getActiveAsistenciasTableKey(), isSA);
    if (thUsu) thUsu.innerHTML = renderTableHead('usuarios', isSA);
}

function openColumnConfigModal(tableKey) {
    // If opening for asistencias and in grouped mode, use the grouped key
    if (tableKey === 'asistencias' && getAsistenciasViewMode() === 'grouped') {
        tableKey = 'asistencias_grouped';
    }
    const modal = document.getElementById('modalColumnConfig');
    const titleMap = { trabajadores: 'Trabajadores', asistencias: 'Asistencias', asistencias_grouped: 'Asistencias (Agrupada)', usuarios: 'Usuarios' };
    document.getElementById('modalColumnConfigTitle').textContent = 'Columnas: ' + (titleMap[tableKey] || tableKey);
    document.getElementById('columnConfigTableKey').value = tableKey;
    const list = document.getElementById('colConfigList');
    const cols = getOrderedColumns(tableKey);
    list.innerHTML = cols.map(c => '<li class="col-config-item" draggable="true" data-col-id="' + c.id + '">' +
        '<span class="drag-handle"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="6" r="1"/><circle cx="15" cy="6" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="9" cy="18" r="1"/><circle cx="15" cy="18" r="1"/></svg></span>' +
        '<label>' + escapeHtml(c.label) + '</label>' +
        '<input type="checkbox" class="col-toggle" ' + (c.visible ? 'checked' : '') + '>' +
        '</li>').join('');
    modal.classList.add('show');
    initDragAndDrop(list);
}

function closeColumnConfigModal() {
    document.getElementById('modalColumnConfig').classList.remove('show');
}

function saveColumnConfigFromModal() {
    const tableKey = document.getElementById('columnConfigTableKey').value;
    const list = document.getElementById('colConfigList');
    const items = list.querySelectorAll('.col-config-item');
    const columns = [];
    const hidden = [];
    items.forEach(item => {
        const id = item.getAttribute('data-col-id');
        columns.push(id);
        if (!item.querySelector('.col-toggle').checked) hidden.push(id);
    });
    if (!state.columnPrefs) state.columnPrefs = getDefaultColumnPrefs();
    const existingViewMode = state.columnPrefs[tableKey]?.viewMode;
    state.columnPrefs[tableKey] = { columns, hidden };
    // Preserve viewMode for asistencias
    if (tableKey === 'asistencias' && existingViewMode) {
        state.columnPrefs[tableKey].viewMode = existingViewMode;
    }
    // Sync shared columns between asistencias views
    if (tableKey === 'asistencias' || tableKey === 'asistencias_grouped') {
        syncAsistenciasColumnPrefs(tableKey);
    }
    saveColumnPrefs();
    renderAllTableHeads();
    updateTablaTrabajadores();
    updateTablaAsistencias();
    updateTablaUsuarios();
    closeColumnConfigModal();
    showToast('Columnas actualizadas', 'success');
}

function syncAsistenciasColumnPrefs(sourceKey) {
    const targetKey = sourceKey === 'asistencias' ? 'asistencias_grouped' : 'asistencias';
    if (!state.columnPrefs[sourceKey] || !state.columnPrefs[targetKey]) return;
    const sharedIds = ['nombre', 'dni', 'cargo', 'fecha', 'punto', 'ubicacion'];
    const sourcePrefs = state.columnPrefs[sourceKey];
    const targetPrefs = state.columnPrefs[targetKey];

    // Sync hidden state for shared columns
    sharedIds.forEach(id => {
        const hiddenInSource = (sourcePrefs.hidden || []).includes(id);
        const hiddenInTarget = (targetPrefs.hidden || []).includes(id);
        if (hiddenInSource && !hiddenInTarget) {
            targetPrefs.hidden.push(id);
        } else if (!hiddenInSource && hiddenInTarget) {
            targetPrefs.hidden = targetPrefs.hidden.filter(h => h !== id);
        }
    });

    // Sync order: keep non-shared columns in place, replace shared slots with source order
    const sourceSharedOrder = sourcePrefs.columns.filter(id => sharedIds.includes(id));
    const sharedPositions = [];
    targetPrefs.columns.forEach((id, idx) => {
        if (sharedIds.includes(id)) sharedPositions.push(idx);
    });
    const newColumns = [...targetPrefs.columns];
    sourceSharedOrder.forEach((id, i) => {
        if (i < sharedPositions.length) newColumns[sharedPositions[i]] = id;
    });
    targetPrefs.columns = newColumns;
}

function resetColumnPrefsFromModal() {
    const tableKey = document.getElementById('columnConfigTableKey').value;
    const defaults = getDefaultColumnPrefs();
    if (!state.columnPrefs) state.columnPrefs = defaults;
    state.columnPrefs[tableKey] = defaults[tableKey];
    // Re-open modal with default values
    openColumnConfigModal(tableKey);
}

function initDragAndDrop(container) {
    let draggedItem = null;
    const items = container.querySelectorAll('.col-config-item');
    items.forEach(item => {
        item.addEventListener('dragstart', function(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });
        item.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            container.querySelectorAll('.col-config-item').forEach(i => i.classList.remove('drag-over'));
            draggedItem = null;
        });
        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (this !== draggedItem) this.classList.add('drag-over');
        });
        item.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });
        item.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            if (draggedItem && this !== draggedItem) {
                const allItems = [...container.querySelectorAll('.col-config-item')];
                const dragIdx = allItems.indexOf(draggedItem);
                const dropIdx = allItems.indexOf(this);
                if (dragIdx < dropIdx) this.after(draggedItem);
                else this.before(draggedItem);
            }
        });
        // Touch support
        let touchStartY = 0;
        let touchClone = null;
        item.addEventListener('touchstart', function(e) {
            draggedItem = this;
            touchStartY = e.touches[0].clientY;
            this.classList.add('dragging');
        }, { passive: true });
        item.addEventListener('touchmove', function(e) {
            if (!draggedItem) return;
            e.preventDefault();
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            container.querySelectorAll('.col-config-item').forEach(i => i.classList.remove('drag-over'));
            if (target) {
                const dropTarget = target.closest('.col-config-item');
                if (dropTarget && dropTarget !== draggedItem) dropTarget.classList.add('drag-over');
            }
        }, { passive: false });
        item.addEventListener('touchend', function(e) {
            if (!draggedItem) return;
            const touch = e.changedTouches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            if (target) {
                const dropTarget = target.closest('.col-config-item');
                if (dropTarget && dropTarget !== draggedItem) {
                    const allItems = [...container.querySelectorAll('.col-config-item')];
                    const dragIdx = allItems.indexOf(draggedItem);
                    const dropIdx = allItems.indexOf(dropTarget);
                    if (dragIdx < dropIdx) dropTarget.after(draggedItem);
                    else dropTarget.before(draggedItem);
                }
            }
            container.querySelectorAll('.col-config-item').forEach(i => i.classList.remove('drag-over'));
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
    });
}

// =====================================================
// AUTENTICACI√ìN
// =====================================================
async function initAuth() {
    if (!db) {
        showToast('Supabase no configurado. Revisa config.js', 'error');
        return;
    }

    const { data: { session } } = await db.auth.getSession();
    if (session) {
        await loadUserProfile(session.user);
        await showApp();
    } else {
        showLogin();
    }

    db.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_OUT') {
            showLogin();
        }
    });
}

async function loadUserProfile(user) {
    const { data: profile } = await db
        .from('user_profiles')
        .select('*')
        .eq('id', user.id)
        .single();

    if (profile) {
        state.currentUser = {
            id: user.id,
            email: user.email,
            username: profile.username,
            nombre: profile.nombre,
            rol: profile.rol
        };
    } else {
        state.currentUser = {
            id: user.id,
            email: user.email,
            username: user.email.split('@')[0],
            nombre: user.email.split('@')[0],
            rol: 'admin'
        };
    }
}

function showLogin() {
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainApp').classList.remove('show');
}

async function showApp() {
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('mainApp').classList.add('show');
    updateUserUI();
    updateDateTime();
    setInterval(updateDateTime, 1000);
    // Filtros de fecha: por defecto hoy (usa fecha local, no UTC)
    const todayStr = getLocalDateString();
    document.getElementById('filterFechaInicio').value = todayStr;
    document.getElementById('filterFechaFin').value = todayStr;
    document.getElementById('configSupabaseUrl').value = SUPABASE_URL;
    document.getElementById('configSupabaseKey').value = SUPABASE_KEY;
    document.getElementById('auditFilterFecha').value = getLocalDateString();
    await loadColumnPrefs();
    renderAllTableHeads();
    updateViewToggleButton();
    syncData();
    checkConnection();
    loadGpsConfig();
    initCharts();
}

async function handleLogin(event) {
    event.preventDefault();
    let emailOrUser = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');
    const loginBtn = document.getElementById('loginBtn');

    loginBtn.disabled = true;
    loginBtn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px"></div> Validando...';

    try {
        let email = emailOrUser;

        // Si no es un email, buscar el email por username
        if (!emailOrUser.includes('@')) {
            const { data: profile } = await db
                .from('user_profiles')
                .select('id')
                .eq('username', emailOrUser.toLowerCase())
                .eq('activo', true)
                .maybeSingle();

            if (profile) {
                // Obtener email de auth.users via funci√≥n o buscar en otra forma
                // Como no podemos acceder a auth.users directamente, guardamos el email en user_profiles
                const { data: profileWithEmail } = await db
                    .from('user_profiles')
                    .select('email')
                    .eq('username', emailOrUser.toLowerCase())
                    .maybeSingle();

                if (profileWithEmail && profileWithEmail.email) {
                    email = profileWithEmail.email;
                } else {
                    errorEl.textContent = 'Usuario no encontrado';
                    errorEl.classList.add('show');
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<span>Iniciar Sesi√≥n</span><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>';
                    return;
                }
            } else {
                errorEl.textContent = 'Usuario no encontrado';
                errorEl.classList.add('show');
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span>Iniciar Sesi√≥n</span><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>';
                return;
            }
        }

        const { data, error } = await db.auth.signInWithPassword({ email, password });

        if (error) {
            errorEl.textContent = 'Usuario o contrase√±a incorrectos';
            errorEl.classList.add('show');
            document.getElementById('loginPassword').value = '';
        } else {
            await loadUserProfile(data.user);
            errorEl.classList.remove('show');
            await showApp();
            showToast('¬°Bienvenido!', 'success');
            logActivity('LOGIN', 'Ingres√≥ al sistema', 'auth');
        }
    } catch (error) {
        errorEl.textContent = 'Error de conexi√≥n. Verifica tu internet.';
        errorEl.classList.add('show');
    } finally {
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<span>Iniciar Sesi√≥n</span><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>';
    }
}

async function handleLogout() {
    await logActivity('LOGOUT', 'Cerr√≥ sesi√≥n', 'auth');
    await db.auth.signOut();
    state.currentUser = null;
    state.columnPrefs = null;
    showLogin();
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginError').classList.remove('show');
}

function updateUserUI() {
    if (!state.currentUser) return;
    const user = state.currentUser;
    document.getElementById('userAvatar').textContent = user.nombre.charAt(0).toUpperCase();
    document.getElementById('userName').textContent = user.nombre;
    const isSA = user.rol === 'super_admin';
    document.getElementById('userRole').textContent = isSA ? 'Super Admin' : 'Administrador';
    document.getElementById('userRole').className = 'user-role' + (isSA ? ' super' : '');
    // Mostrar bot√≥n agregar admin solo para super_admin
    const btnAgregarAdmin = document.getElementById('btnAgregarAdmin');
    if (btnAgregarAdmin) btnAgregarAdmin.style.display = isSA ? 'flex' : 'none';
    // Ocultar Usuarios Admin para admin (solo super_admin)
    const navUsuarios = document.getElementById('navUsuarios');
    if (navUsuarios) navUsuarios.style.display = isSA ? 'flex' : 'none';
    // Ocultar Registro de Actividades para admin (solo super_admin)
    const navAudit = document.getElementById('navAuditLog');
    if (navAudit) navAudit.style.display = isSA ? 'flex' : 'none';
    // Ocultar Configuraci√≥n para admin (solo super_admin)
    const navConfig = document.getElementById('navConfiguracion');
    if (navConfig) navConfig.style.display = isSA ? 'flex' : 'none';
    // Mostrar email en sidebar
    document.getElementById('userEmail').textContent = user.email || '';
}

function isSuperAdmin() {
    return state.currentUser && state.currentUser.rol === 'super_admin';
}

// =====================================================
// REGISTRO DE ACTIVIDADES (AUDITOR√çA)
// =====================================================
async function logActivity(accion, detalle, seccion) {
    if (!state.currentUser || !db) return;
    try {
        await db.from('audit_log').insert({
            user_id: state.currentUser.id,
            username: state.currentUser.username || state.currentUser.nombre,
            accion: accion,
            detalle: detalle,
            seccion: seccion || null,
            user_agent: navigator.userAgent
        });
    } catch (e) {
        // No bloquear la acci√≥n si falla el log
    }
}

async function loadAuditLog() {
    if (!isSuperAdmin()) return;
    try {
        const { data } = await db.from('audit_log').select('*').order('timestamp', { ascending: false }).limit(500);
        state.auditLogs = data || [];
    } catch (e) {
        state.auditLogs = [];
    }
}

function updateAuditDashboard() {
    if (!isSuperAdmin()) return;
    const today = getLocalDateString();
    const todayLogs = state.auditLogs.filter(l => l.timestamp && l.timestamp.startsWith(today));
    const logins = todayLogs.filter(l => l.accion === 'LOGIN');
    const usuarios = new Set(todayLogs.map(l => l.username));

    document.getElementById('auditStatLogins').textContent = logins.length;
    document.getElementById('auditStatAcciones').textContent = todayLogs.length;
    document.getElementById('auditStatUsuarios').textContent = usuarios.size;
    document.getElementById('auditStatTotal').textContent = state.auditLogs.length;

    // Tabla de √∫ltimo acceso por usuario
    const userMap = {};
    state.auditLogs.forEach(l => {
        if (!userMap[l.username]) {
            userMap[l.username] = { username: l.username, lastLogin: null, loginsToday: 0, actionsToday: 0 };
        }
        if (l.accion === 'LOGIN' && (!userMap[l.username].lastLogin || l.timestamp > userMap[l.username].lastLogin)) {
            userMap[l.username].lastLogin = l.timestamp;
        }
        if (l.timestamp && l.timestamp.startsWith(today)) {
            userMap[l.username].actionsToday++;
            if (l.accion === 'LOGIN') userMap[l.username].loginsToday++;
        }
    });

    const tbody = document.getElementById('tablaAuditUsuarios');
    const users = Object.values(userMap).sort((a, b) => (b.lastLogin || '').localeCompare(a.lastLogin || ''));
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No hay registros de actividad</td></tr>';
        return;
    }
    tbody.innerHTML = users.map(u => {
        const profile = state.usuarios.find(p => p.username === u.username);
        const email = profile ? escapeHtml(profile.email || '') : '';
        const rol = profile ? (profile.rol === 'super_admin' ? '<span class="badge super_admin">Super Admin</span>' : '<span class="badge admin">Admin</span>') : '-';
        const lastLogin = u.lastLogin ? new Date(u.lastLogin).toLocaleString('es-PE') : 'Nunca';
        return '<tr><td><strong>' + escapeHtml(u.username) + '</strong></td><td>' + email + '</td><td>' + rol + '</td><td>' + escapeHtml(lastLogin) + '</td><td>' + u.loginsToday + '</td><td>' + u.actionsToday + '</td></tr>';
    }).join('');

    // Poblar filtro de usuarios
    const select = document.getElementById('auditFilterUsuario');
    const currentVal = select.value;
    select.innerHTML = '<option value="">Todos los usuarios</option>';
    const uniqueUsers = [...new Set(state.auditLogs.map(l => l.username))].sort();
    uniqueUsers.forEach(u => {
        select.innerHTML += '<option value="' + escapeHtml(u) + '">' + escapeHtml(u) + '</option>';
    });
    select.value = currentVal;

    filterAuditLog();
}

async function updateDashboardAuditList() {
    if (!isSuperAdmin()) return;
    await loadAuditLog();
    const today = getLocalDateString();
    const todayLogs = state.auditLogs.filter(l => l.timestamp && l.timestamp.startsWith(today)).slice(0, 10);
    const list = document.getElementById('dashboardAuditList');
    if (todayLogs.length === 0) {
        list.innerHTML = '<li class="activity-item"><div style="text-align:center;width:100%;padding:30px;color:var(--gray-400)">No hay actividad de admins hoy</div></li>';
        return;
    }
    const accionIcons = { 'LOGIN': 'üîë', 'LOGOUT': 'üö™', 'NAVIGATE': 'üìÑ', 'CREATE': '‚ûï', 'UPDATE': '‚úèÔ∏è', 'DELETE': 'üóëÔ∏è', 'EXPORT': 'üìä', 'CONFIG': '‚öôÔ∏è' };
    list.innerHTML = todayLogs.map(l => {
        const ts = new Date(l.timestamp);
        const hora = ts.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
        const icon = accionIcons[l.accion] || 'üìã';
        return '<li class="activity-item"><div class="activity-icon">' + icon + '</div><div class="activity-content"><div class="activity-name">' + escapeHtml(l.username || '') + '</div><div class="activity-detail">' + escapeHtml(l.accion) + ' ‚Ä¢ ' + escapeHtml(l.detalle || '') + '</div></div><div class="activity-time">' + hora + '</div></li>';
    }).join('');
}

function filterAuditLog() {
    const accion = document.getElementById('auditFilterAccion').value;
    const usuario = document.getElementById('auditFilterUsuario').value;
    const fecha = document.getElementById('auditFilterFecha').value;

    let filtered = state.auditLogs;
    if (accion) filtered = filtered.filter(l => l.accion === accion);
    if (usuario) filtered = filtered.filter(l => l.username === usuario);
    if (fecha) filtered = filtered.filter(l => l.timestamp && l.timestamp.startsWith(fecha));

    const tbody = document.getElementById('tablaAuditLog');
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No hay registros</td></tr>';
        return;
    }

    const accionBadges = {
        'LOGIN': 'green', 'LOGOUT': 'yellow', 'NAVIGATE': 'blue',
        'CREATE': 'green', 'UPDATE': 'blue', 'DELETE': 'red',
        'EXPORT': 'yellow', 'CONFIG': 'red'
    };

    tbody.innerHTML = filtered.slice(0, 200).map(l => {
        const ts = new Date(l.timestamp);
        const fechaStr = getLocalDateString(ts);
        const horaStr = ts.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const badgeColor = accionBadges[l.accion] || 'blue';
        const badgeStyle = 'display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;background:var(--' + badgeColor + '-50, #f0fdf4);color:var(--' + badgeColor + '-700, #15803d)';
        return '<tr><td>' + escapeHtml(fechaStr) + '</td><td>' + escapeHtml(horaStr) + '</td><td><strong>' + escapeHtml(l.username || '') + '</strong></td><td><span style="' + badgeStyle + '">' + escapeHtml(l.accion) + '</span></td><td>' + escapeHtml(l.detalle || '') + '</td><td>' + escapeHtml(l.seccion || '-') + '</td></tr>';
    }).join('');
}

// =====================================================
// SUPABASE CONFIG
// =====================================================
function saveSupabaseConfig() {
    const url = document.getElementById('configSupabaseUrl').value.trim();
    const key = document.getElementById('configSupabaseKey').value.trim();

    if (!url || !key) {
        showToast('Completa ambos campos', 'error');
        return;
    }

    localStorage.setItem('supabase_url', url);
    localStorage.setItem('supabase_key', key);
    showToast('Configuraci√≥n guardada. Recargando...', 'success');
    logActivity('CONFIG', 'Actualiz√≥ configuraci√≥n de Supabase', 'configuracion');
    setTimeout(() => location.reload(), 1000);
}

// =====================================================
// NAVEGACI√ìN
// =====================================================
function showPage(pageName, element) {
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    if (element) element.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + pageName).classList.add('active');
    const titles = { 'dashboard': 'Dashboard', 'trabajadores': 'Trabajadores', 'asistencias': 'Asistencias', 'puntos': 'Puntos QR', 'usuarios': 'Usuarios Admin', 'audit': 'Registro de Actividades', 'configuracion': 'Configuraci√≥n' };
    document.getElementById('pageTitle').textContent = titles[pageName];
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('show');
    if (pageName === 'puntos') setTimeout(updatePuntosGrid, 100);
    if (pageName === 'usuarios') loadUsers().then(() => updateTablaUsuarios());
    if (pageName === 'audit') loadAuditLog().then(() => { loadUsers().then(() => updateAuditDashboard()); });
    logActivity('NAVIGATE', 'Visit√≥ secci√≥n ' + (titles[pageName] || pageName), pageName);
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('overlay').classList.toggle('show');
}

// =====================================================
// UTILIDAD DE FECHA LOCAL
// =====================================================
function getLocalDateString(date = new Date()) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}

// =====================================================
// DASHBOARD
// =====================================================
function updateDashboard() {
    const today = getLocalDateString();
    const todayRecords = state.asistencias.filter(a => a.fecha === today);
    const entradas = todayRecords.filter(a => a.tipo === 'ENTRADA');
    const salidas = todayRecords.filter(a => a.tipo === 'SALIDA');
    const presentes = new Set();
    todayRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)).forEach(r => { if (r.tipo === 'ENTRADA') presentes.add(r.dni); else presentes.delete(r.dni); });
    document.getElementById('statPresentes').textContent = presentes.size;
    document.getElementById('statEntradas').textContent = entradas.length;
    document.getElementById('statSalidas').textContent = salidas.length;
    document.getElementById('statTotal').textContent = todayRecords.length;
    document.getElementById('quickTrabajadores').textContent = state.trabajadores.length;
    document.getElementById('quickPuntos').textContent = state.puntos.length;
    const pct = state.trabajadores.length > 0 ? Math.round((new Set(entradas.map(e => e.dni)).size / state.trabajadores.length) * 100) : 0;
    document.getElementById('quickAsistencia').textContent = pct + '%';
    document.getElementById('badgeTrabajadores').textContent = state.trabajadores.length;
    updateActivityList(todayRecords.slice(-10).reverse());
    // Panel de auditor√≠a en dashboard (solo super_admin)
    const auditCard = document.getElementById('dashboardAuditCard');
    if (isSuperAdmin()) {
        auditCard.style.display = 'block';
        updateDashboardAuditList();
    } else {
        auditCard.style.display = 'none';
    }
}

function updateActivityList(records) {
    const list = document.getElementById('activityList');
    if (records.length === 0) { list.innerHTML = '<li class="activity-item"><div style="text-align:center;width:100%;padding:30px;color:var(--gray-400)">No hay actividad hoy</div></li>'; return; }
    list.innerHTML = records.map(r => '<li class="activity-item"><div class="activity-icon ' + r.tipo.toLowerCase() + '">' + (r.tipo === 'ENTRADA' ? '‚úÖ' : 'üö™') + '</div><div class="activity-content"><div class="activity-name">' + escapeHtml(r.nombre) + '</div><div class="activity-detail">' + escapeHtml(r.tipo) + ' ‚Ä¢ ' + escapeHtml(r.punto || 'Principal') + '</div></div><div class="activity-time">' + escapeHtml(r.hora) + '</div></li>').join('');
}

// =====================================================
// TRABAJADORES
// =====================================================
function updateTablaTrabajadores() {
    const tbody = document.getElementById('tablaTrabajadores');
    const search = document.getElementById('searchTrabajador').value.toLowerCase();
    let filtered = state.trabajadores;
    if (search) filtered = filtered.filter(t => t.dni.includes(search) || t.nombre.toLowerCase().includes(search) || t.cargo.toLowerCase().includes(search) || t.area.toLowerCase().includes(search));
    const isSA = isSuperAdmin();
    const visCols = getVisibleColumns('trabajadores');
    const colspan = visCols.length + (isSA ? 1 : 0);
    if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="' + colspan + '" class="empty-state"><h3>No hay trabajadores</h3><p>Agrega trabajadores para comenzar</p></td></tr>'; return; }
    tbody.innerHTML = filtered.map(t => {
        if (!isSA) return renderTableRow('trabajadores', t);
        const actions = '<div class="action-btns"><button class="btn btn-sm btn-secondary" onclick="editTrabajador(\'' + escapeHtml(t.dni) + '\')">Editar</button><button class="btn btn-sm btn-danger" onclick="deleteTrabajador(\'' + escapeHtml(t.dni) + '\')">Eliminar</button></div>';
        return renderTableRow('trabajadores', t, actions);
    }).join('');
}

function filterTrabajadores() { updateTablaTrabajadores(); }
function openModalTrabajador(t) {
    const form = document.getElementById('formTrabajador');
    form.reset();
    document.getElementById('editingDni').value = '';
    document.getElementById('inputDni').disabled = false;
    if (t) {
        document.getElementById('modalTrabajadorTitle').textContent = 'Editar Trabajador';
        document.getElementById('editingDni').value = t.dni;
        document.getElementById('inputDni').value = t.dni;
        document.getElementById('inputDni').disabled = true;
        document.getElementById('inputNombre').value = t.nombre;
        document.getElementById('inputCargo').value = t.cargo;
        document.getElementById('inputArea').value = t.area;
    } else {
        document.getElementById('modalTrabajadorTitle').textContent = 'Agregar Trabajador';
    }
    document.getElementById('modalTrabajador').classList.add('show');
}
function closeModalTrabajador() { document.getElementById('modalTrabajador').classList.remove('show'); }
function editTrabajador(dni) { const t = state.trabajadores.find(w => w.dni === dni); if (t) openModalTrabajador(t); }

async function saveTrabajador(e) {
    e.preventDefault();
    const dni = document.getElementById('inputDni').value.trim();
    const nombre = document.getElementById('inputNombre').value.trim().toUpperCase();
    const cargo = document.getElementById('inputCargo').value.trim().toUpperCase();
    const area = document.getElementById('inputArea').value.trim().toUpperCase();
    const editingDni = document.getElementById('editingDni').value;

    showLoading(true);
    try {
        if (editingDni) {
            const { error } = await db.from('empleados').update({ nombre, cargo, area }).eq('dni', editingDni);
            if (error) throw error;
        } else {
            const { error } = await db.from('empleados').insert({ dni, nombre, cargo, area });
            if (error) {
                if (error.code === '23505') {
                    showToast('El DNI ya existe', 'error');
                    showLoading(false);
                    return;
                }
                throw error;
            }
        }
        closeModalTrabajador();
        showToast('Trabajador ' + (editingDni ? 'actualizado' : 'agregado'), 'success');
        logActivity(editingDni ? 'UPDATE' : 'CREATE', (editingDni ? 'Actualiz√≥' : 'Agreg√≥') + ' trabajador ' + nombre + ' (DNI: ' + dni + ')', 'trabajadores');
        await loadEmployees();
        updateAll();
    } catch (error) {
        showToast('Error al guardar', 'error');
    } finally {
        showLoading(false);
    }
}

async function deleteTrabajador(dni) {
    if (!confirm('¬øEliminar este trabajador?')) return;
    showLoading(true);
    try {
        const worker = state.trabajadores.find(t => t.dni === dni);
        const { error } = await db.from('empleados').delete().eq('dni', dni);
        if (error) throw error;
        showToast('Trabajador eliminado', 'success');
        logActivity('DELETE', 'Elimin√≥ trabajador ' + (worker ? worker.nombre : '') + ' (DNI: ' + dni + ')', 'trabajadores');
        await loadEmployees();
        updateAll();
    } catch (error) {
        showToast('Error al eliminar', 'error');
    } finally {
        showLoading(false);
    }
}

// =====================================================
// ASISTENCIAS
// =====================================================
async function deleteAsistencia(id) {
    if (!confirm('¬øEliminar este registro de asistencia?')) return;
    showLoading(true);
    try {
        const { error } = await db.from('asistencias').delete().eq('id', id);
        if (error) throw error;
        showToast('Registro eliminado', 'success');
        await loadAttendance();
        updateAll();
    } catch (error) {
        showToast('Error al eliminar registro', 'error');
    } finally {
        showLoading(false);
    }
}

function editAsistencia(id) {
    const a = state.asistencias.find(r => r.id === id);
    if (!a) { showToast('Registro no encontrado', 'error'); return; }
    openModalAsistencia(a);
}

function openModalAsistencia(a) {
    document.getElementById('editingAsistenciaId').value = a.id;
    document.getElementById('inputAsistenciaNombre').value = a.nombre;
    document.getElementById('inputAsistenciaFecha').value = a.fecha;
    document.getElementById('inputAsistenciaHora').value = a.hora;
    document.getElementById('inputAsistenciaTipo').value = a.tipo;
    document.getElementById('modalAsistencia').classList.add('show');
}

function closeModalAsistencia() { document.getElementById('modalAsistencia').classList.remove('show'); }

async function saveAsistencia(e) {
    e.preventDefault();
    const id = document.getElementById('editingAsistenciaId').value;
    const fecha = document.getElementById('inputAsistenciaFecha').value;
    const hora = document.getElementById('inputAsistenciaHora').value;
    const tipo = document.getElementById('inputAsistenciaTipo').value;
    const timestamp = new Date(fecha + 'T' + hora).toISOString();
    showLoading(true);
    try {
        const { error } = await db.from('asistencias').update({ fecha, hora, tipo, timestamp }).eq('id', id);
        if (error) throw error;
        showToast('Asistencia actualizada', 'success');
        closeModalAsistencia();
        await loadAttendance();
        updateAll();
    } catch (error) {
        showToast('Error al actualizar asistencia', 'error');
    } finally {
        showLoading(false);
    }
}

function getFilteredAsistencias(skipTipo) {
    const search = document.getElementById('searchAsistencia').value.toLowerCase();
    const fechaInicio = document.getElementById('filterFechaInicio').value;
    const fechaFin = document.getElementById('filterFechaFin').value;
    const tipo = document.getElementById('filterTipo').value;
    let filtered = state.asistencias;

    if (fechaInicio && fechaFin) {
        filtered = filtered.filter(a => a.fecha >= fechaInicio && a.fecha <= fechaFin);
    } else if (fechaInicio) {
        filtered = filtered.filter(a => a.fecha === fechaInicio);
    }
    if (tipo && !skipTipo) filtered = filtered.filter(a => a.tipo === tipo);
    if (search) filtered = filtered.filter(a => a.nombre.toLowerCase().includes(search) || a.dni.includes(search));
    filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    return filtered;
}

function getAsistenciasViewMode() {
    return state.columnPrefs?.asistencias?.viewMode || 'detailed';
}

function getActiveAsistenciasTableKey() {
    return getAsistenciasViewMode() === 'grouped' ? 'asistencias_grouped' : 'asistencias';
}

function getGroupedAsistencias(filtered, tipoFilter) {
    const groups = {};
    filtered.forEach(a => {
        const key = a.dni + '|' + a.fecha;
        if (!groups[key]) {
            groups[key] = { nombre: a.nombre, dni: a.dni, cargo: a.cargo || '', fecha: a.fecha, entradas: [], salidas: [] };
        }
        if (a.tipo === 'ENTRADA') groups[key].entradas.push(a);
        else if (a.tipo === 'SALIDA') groups[key].salidas.push(a);
    });
    let result = Object.values(groups);
    // Filter groups by type: show only groups that have at least one record of that type
    if (tipoFilter === 'ENTRADA') result = result.filter(g => g.entradas.length > 0);
    else if (tipoFilter === 'SALIDA') result = result.filter(g => g.salidas.length > 0);
    return result.map(g => {
        g.entradas.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        g.salidas.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        const entrada = g.entradas[0] || null;
        const salida = g.salidas.length > 0 ? g.salidas[g.salidas.length - 1] : null;
        return {
            nombre: g.nombre,
            dni: g.dni,
            cargo: g.cargo,
            fecha: g.fecha,
            horaEntrada: entrada ? entrada.hora : null,
            horaSalida: salida ? salida.hora : null,
            punto: entrada ? (entrada.punto || '-') : (salida ? (salida.punto || '-') : '-'),
            lat: entrada ? entrada.lat : (salida ? salida.lat : null),
            lng: entrada ? entrada.lng : (salida ? salida.lng : null),
            entradaId: entrada ? entrada.id : null,
            salidaId: salida ? salida.id : null
        };
    }).sort((a, b) => {
        if (a.fecha !== b.fecha) return a.fecha < b.fecha ? 1 : -1;
        return a.nombre.localeCompare(b.nombre);
    });
}

function toggleAsistenciasView() {
    if (!state.columnPrefs) state.columnPrefs = getDefaultColumnPrefs();
    const current = getAsistenciasViewMode();
    state.columnPrefs.asistencias.viewMode = current === 'detailed' ? 'grouped' : 'detailed';
    saveColumnPrefs();
    renderAllTableHeads();
    updateTablaAsistencias();
    updateViewToggleButton();
}

function updateViewToggleButton() {
    const mode = getAsistenciasViewMode();
    const textEl = document.getElementById('btnViewToggleText');
    const iconEl = document.getElementById('btnViewToggleIcon');
    if (textEl) textEl.textContent = mode === 'detailed' ? 'Agrupada' : 'Detallada';
    if (iconEl) iconEl.setAttribute('data-lucide', mode === 'detailed' ? 'list' : 'rows-3');
    lucide.createIcons();
}

function updateTablaAsistencias() {
    const tbody = document.getElementById('tablaAsistencias');
    const tableKey = getActiveAsistenciasTableKey();
    const isSA = isSuperAdmin();
    const visCols = getVisibleColumns(tableKey);
    const colspan = visCols.length + (isSA ? 1 : 0);
    if (getAsistenciasViewMode() === 'grouped') {
        const allFiltered = getFilteredAsistencias(true);
        const tipoFilter = document.getElementById('filterTipo').value;
        const grouped = getGroupedAsistencias(allFiltered, tipoFilter);
        if (grouped.length === 0) { tbody.innerHTML = '<tr><td colspan="' + colspan + '" class="empty-state"><h3>No hay registros</h3><p>No se encontraron asistencias</p></td></tr>'; return; }
        tbody.innerHTML = grouped.map(a => {
            if (!isSA) return renderTableRow(tableKey, a);
            let btns = '';
            if (a.entradaId) btns += '<button class="btn btn-sm btn-secondary" onclick="editAsistencia(\'' + a.entradaId + '\')" title="Editar entrada"><i data-lucide="pencil" style="width:14px;height:14px"></i> E</button>';
            if (a.salidaId) btns += '<button class="btn btn-sm btn-secondary" onclick="editAsistencia(\'' + a.salidaId + '\')" title="Editar salida"><i data-lucide="pencil" style="width:14px;height:14px"></i> S</button>';
            if (a.entradaId) btns += '<button class="btn btn-sm btn-danger" onclick="deleteAsistencia(\'' + a.entradaId + '\')" title="Eliminar entrada"><i data-lucide="trash-2" style="width:14px;height:14px"></i> E</button>';
            if (a.salidaId) btns += '<button class="btn btn-sm btn-danger" onclick="deleteAsistencia(\'' + a.salidaId + '\')" title="Eliminar salida"><i data-lucide="trash-2" style="width:14px;height:14px"></i> S</button>';
            const actions = '<div class="action-btns">' + btns + '</div>';
            return renderTableRow(tableKey, a, actions);
        }).join('');
    } else {
        const filtered = getFilteredAsistencias();
        if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="' + colspan + '" class="empty-state"><h3>No hay registros</h3><p>No se encontraron asistencias</p></td></tr>'; return; }
        tbody.innerHTML = filtered.map(a => {
            if (!isSA) return renderTableRow(tableKey, a);
            const actions = '<div class="action-btns"><button class="btn btn-sm btn-secondary" onclick="editAsistencia(\'' + a.id + '\')" title="Editar registro"><i data-lucide="pencil" style="width:14px;height:14px"></i></button><button class="btn btn-sm btn-danger" onclick="deleteAsistencia(\'' + a.id + '\')" title="Eliminar registro"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button></div>';
            return renderTableRow(tableKey, a, actions);
        }).join('');
    }
    lucide.createIcons();
}
function filterAsistencias() { updateTablaAsistencias(); }

// =====================================================
// PUNTOS QR
// =====================================================
function updatePuntosGrid() {
    const grid = document.getElementById('puntosGrid');
    const baseUrl = window.location.href.replace(/admin\.html.*$/, 'marcar.html');
    if (state.puntos.length === 0) { grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><h3>No hay puntos configurados</h3><p>Crea tu primer punto de marcaci√≥n</p></div>'; return; }
    grid.innerHTML = state.puntos.map(p => {
        const url = baseUrl + '?punto=' + p.id;
        return '<div class="punto-card"><h3>üìç ' + escapeHtml(p.nombre) + '</h3><div class="punto-qr" id="qr-' + escapeHtml(p.id) + '"></div><div class="punto-url" style="font-size:10px">' + escapeHtml(url) + '</div><div class="punto-actions"><button class="btn btn-sm btn-secondary" onclick="copyUrl(\'' + url.replace(/'/g, "\\'") + '\')">üìã Copiar</button><button class="btn btn-sm btn-primary" onclick="downloadQR(\'' + escapeHtml(p.id) + '\')">‚¨áÔ∏è Descargar</button><button class="btn btn-sm btn-danger" onclick="deletePunto(\'' + escapeHtml(p.id) + '\')">üóëÔ∏è</button></div></div>';
    }).join('');
    setTimeout(() => {
        state.puntos.forEach(p => {
            const container = document.getElementById('qr-' + p.id);
            if (container && container.children.length === 0) {
                const url = baseUrl + '?punto=' + p.id;
                new QRCode(container, { text: url, width: 180, height: 180, colorDark: '#16a34a', colorLight: '#ffffff' });
            }
        });
    }, 100);
}

function openModalPunto() {
    document.getElementById('modalPunto').classList.add('show');
    document.getElementById('formPunto').reset();
    document.getElementById('inputPuntoRadio').value = 150;
}
function closeModalPunto() { document.getElementById('modalPunto').classList.remove('show'); }

async function savePunto(e) {
    e.preventDefault();
    const latVal = document.getElementById('inputPuntoLat').value.trim();
    const lngVal = document.getElementById('inputPuntoLng').value.trim();
    if (!latVal || !lngVal) { showToast('Debes ingresar latitud y longitud.', 'error'); return; }
    const punto = {
        id: document.getElementById('inputPuntoId').value.trim().toUpperCase().replace(/\s+/g, '_'),
        nombre: document.getElementById('inputPuntoNombre').value.trim(),
        lat: parseFloat(latVal),
        lng: parseFloat(lngVal),
        radio: parseInt(document.getElementById('inputPuntoRadio').value) || 150,
        activo: true
    };
    if (isNaN(punto.lat) || isNaN(punto.lng)) { showToast('Coordenadas inv√°lidas', 'error'); return; }

    showLoading(true);
    try {
        const { error } = await db.from('qr_points').insert(punto);
        if (error) {
            if (error.code === '23505') {
                showToast('Ya existe un punto con ese ID', 'error');
                showLoading(false);
                return;
            }
            throw error;
        }
        closeModalPunto();
        showToast('Punto creado', 'success');
        logActivity('CREATE', 'Cre√≥ punto QR: ' + punto.nombre + ' (' + punto.id + ')', 'puntos');
        await loadPoints();
        updatePuntosGrid();
    } catch (error) {
        showToast('Error al crear punto', 'error');
    } finally {
        showLoading(false);
    }
}

async function deletePunto(id) {
    if (!confirm('¬øEliminar este punto?')) return;
    showLoading(true);
    try {
        const punto = state.puntos.find(p => p.id === id);
        const { error } = await db.from('qr_points').delete().eq('id', id);
        if (error) throw error;
        showToast('Punto eliminado', 'success');
        logActivity('DELETE', 'Elimin√≥ punto QR: ' + (punto ? punto.nombre : id) + ' (' + id + ')', 'puntos');
        await loadPoints();
        updatePuntosGrid();
    } catch (error) {
        showToast('Error al eliminar', 'error');
    } finally {
        showLoading(false);
    }
}

function copyUrl(url) { navigator.clipboard.writeText(url); showToast('URL copiada', 'success'); }
function downloadQR(id) {
    const punto = state.puntos.find(p => p.id === id);
    const nombre = punto ? punto.nombre : id;
    const container = document.getElementById('qr-' + id);
    const canvas = container.querySelector('canvas');
    if (canvas) {
        const link = document.createElement('a');
        link.download = 'QR_' + nombre.replace(/\s+/g, '_') + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast('QR descargado', 'success');
    }
}

// =====================================================
// USUARIOS
// =====================================================
async function loadUsers() {
    try {
        const { data } = await db.from('user_profiles').select('*').eq('activo', true).order('fecha_creacion', { ascending: true });
        state.usuarios = data || [];
    } catch (e) {}
}

function updateTablaUsuarios() {
    const tbody = document.getElementById('tablaUsuarios');
    const search = document.getElementById('searchUsuario').value.toLowerCase();
    let filtered = state.usuarios;
    if (search) filtered = filtered.filter(u => u.username.toLowerCase().includes(search) || u.nombre.toLowerCase().includes(search) || (u.email && u.email.toLowerCase().includes(search)));
    const isSA = isSuperAdmin();
    const visCols = getVisibleColumns('usuarios');
    const colspan = visCols.length + (isSA ? 1 : 0);
    if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="' + colspan + '" class="empty-state"><h3>No hay usuarios</h3><p>Agrega un administrador</p></td></tr>'; return; }
    tbody.innerHTML = filtered.map(u => {
        const isCurrentUser = state.currentUser && u.id === state.currentUser.id;
        const actions = isSA && !isCurrentUser ? '<button class="btn btn-sm btn-danger" onclick="deleteUsuario(\'' + u.id + '\')"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>' : '-';
        return renderTableRow('usuarios', u, actions, { isCurrentUser });
    }).join('');
    lucide.createIcons();
}

function filterUsuarios() { updateTablaUsuarios(); }

function openModalUsuario() {
    document.getElementById('formUsuario').reset();
    document.getElementById('modalUsuario').classList.add('show');
    lucide.createIcons();
}

function closeModalUsuario() {
    document.getElementById('modalUsuario').classList.remove('show');
}

async function saveUsuario(event) {
    event.preventDefault();
    const email = document.getElementById('inputUserEmail').value.trim();
    const password = document.getElementById('inputUserPassword').value;
    const nombre = document.getElementById('inputUserNombre').value.trim();
    const username = document.getElementById('inputUserUsername').value.trim().toLowerCase().replace(/\s+/g, '');
    const rol = document.getElementById('inputUserRol').value;

    if (!email || !password || !nombre || !username) {
        showToast('Completa todos los campos', 'error');
        return;
    }

    if (password.length < 6) {
        showToast('La contrase√±a debe tener al menos 6 caracteres', 'error');
        return;
    }

    showLoading(true);
    try {
        // Crear usuario en Supabase Auth
        const { data: authData, error: authError } = await db.auth.signUp({
            email: email,
            password: password
        });

        if (authError) {
            if (authError.message.includes('already registered')) {
                showToast('Este email ya est√° registrado', 'error');
            } else {
                showToast(authError.message, 'error');
            }
            showLoading(false);
            return;
        }

        if (!authData.user) {
            showToast('Error al crear usuario', 'error');
            showLoading(false);
            return;
        }

        // Crear perfil en user_profiles (incluir email para login por username)
        const { error: profileError } = await db.from('user_profiles').insert({
            id: authData.user.id,
            username: username,
            nombre: nombre,
            email: email,
            rol: rol,
            activo: true
        });

        if (profileError) {
            showToast('Usuario creado pero error en perfil: ' + profileError.message, 'warning');
        } else {
            showToast('Usuario creado correctamente', 'success');
        }
        logActivity('CREATE', 'Cre√≥ usuario admin: ' + username + ' (' + email + ', rol: ' + rol + ')', 'usuarios');

        closeModalUsuario();
        await loadUsers();
        updateTablaUsuarios();
    } catch (error) {
        showToast('Error al crear usuario', 'error');
    } finally {
        showLoading(false);
    }
}

async function deleteUsuario(id) {
    if (!confirm('¬øEliminar este usuario? Esta acci√≥n no se puede deshacer.')) return;

    showLoading(true);
    try {
        const usuario = state.usuarios.find(u => u.id === id);
        // Desactivar en user_profiles (no podemos eliminar de auth sin service_role)
        const { error } = await db.from('user_profiles').update({ activo: false }).eq('id', id);
        if (error) throw error;

        showToast('Usuario desactivado', 'success');
        logActivity('DELETE', 'Desactiv√≥ usuario admin: ' + (usuario ? usuario.username : id), 'usuarios');
        await loadUsers();
        updateTablaUsuarios();
    } catch (error) {
        showToast('Error al eliminar usuario', 'error');
    } finally {
        showLoading(false);
    }
}

// =====================================================
// SINCRONIZACI√ìN
// =====================================================
async function loadEmployees() {
    try {
        const { data } = await db.from('empleados').select('*').order('nombre', { ascending: true });
        state.trabajadores = data || [];
    } catch (e) {}
}

async function loadAttendance() {
    try {
        const { data } = await db.from('asistencias').select('*').order('timestamp', { ascending: false }).limit(500);
        state.asistencias = data || [];
    } catch (e) {}
}

async function loadPoints() {
    try {
        const { data } = await db.from('qr_points').select('*').eq('activo', true);
        state.puntos = data || [];
    } catch (e) {}
}

async function syncData() {
    showLoading(true);
    try {
        await Promise.all([loadEmployees(), loadAttendance(), loadPoints()]);
        updateAll();
        showToast('Datos sincronizados', 'success');
    } catch (error) {
        showToast('Error al sincronizar', 'warning');
    } finally {
        showLoading(false);
    }
}

function updateAll() {
    updateDashboard();
    updateTablaTrabajadores();
    updateTablaAsistencias();
    updatePuntosGrid();
    updateCharts();
}

function checkConnection() {
    const dot = document.getElementById('syncDot');
    const text = document.getElementById('syncText');
    if (navigator.onLine) { dot.classList.remove('offline'); text.textContent = 'Conectado'; }
    else { dot.classList.add('offline'); text.textContent = 'Sin conexi√≥n'; }
}
window.addEventListener('online', checkConnection);
window.addEventListener('offline', checkConnection);

// =====================================================
// EXPORTAR
// =====================================================
function exportTrabajadores() {
    const cols = getVisibleColumns('trabajadores');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(20); doc.setTextColor(22, 163, 74);
    doc.text('Manuelita - Lista de Trabajadores', 14, 22);
    doc.setFontSize(11); doc.setTextColor(100);
    doc.text('Generado: ' + new Date().toLocaleString() + ' | Por: ' + (state.currentUser?.nombre || 'Admin'), 14, 32);
    doc.autoTable({ startY: 40, head: [cols.map(c => c.label)], body: state.trabajadores.map(t => cols.map(c => c.renderPdf(t))), headStyles: { fillColor: [22, 163, 74] } });
    doc.save('trabajadores_manuelita.pdf');
    showToast('PDF generado', 'success');
    logActivity('EXPORT', 'Export√≥ lista de trabajadores a PDF (' + state.trabajadores.length + ' registros)', 'trabajadores');
}

function exportAsistencias() {
    const isGrouped = getAsistenciasViewMode() === 'grouped';
    const tipoFilter = document.getElementById('filterTipo').value;
    const filtered = getFilteredAsistencias(isGrouped);
    if (filtered.length === 0) { showToast('No hay registros para exportar', 'warning'); return; }
    const tableKey = getActiveAsistenciasTableKey();
    const exportData = isGrouped ? getGroupedAsistencias(filtered, tipoFilter) : filtered;
    const cols = getVisibleColumns(tableKey);
    const fechaInicio = document.getElementById('filterFechaInicio').value;
    const fechaFin = document.getElementById('filterFechaFin').value;
    const rangoFecha = fechaInicio === fechaFin ? fechaInicio : fechaInicio + ' a ' + fechaFin;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l');
    doc.setFontSize(20); doc.setTextColor(22, 163, 74);
    doc.text('Manuelita - Reporte de Asistencia', 14, 22);
    doc.setFontSize(11); doc.setTextColor(100);
    doc.text('Fecha: ' + rangoFecha + ' | Total: ' + exportData.length + ' registros | Por: ' + (state.currentUser?.nombre || 'Admin'), 14, 32);
    doc.autoTable({ startY: 40, head: [cols.map(c => c.label)], body: exportData.map(a => cols.map(c => c.renderPdf(a))), headStyles: { fillColor: [22, 163, 74] } });
    doc.save('asistencia_' + fechaInicio + '.pdf');
    showToast('PDF generado', 'success');
    logActivity('EXPORT', 'Export√≥ asistencias a PDF (' + exportData.length + ' registros, fecha: ' + rangoFecha + ')', 'asistencias');
}

function exportAsistenciasExcel() {
    const isGrouped = getAsistenciasViewMode() === 'grouped';
    const tipoFilter = document.getElementById('filterTipo').value;
    const filtered = getFilteredAsistencias(isGrouped);
    if (filtered.length === 0) { showToast('No hay registros para exportar', 'warning'); return; }
    const tableKey = getActiveAsistenciasTableKey();
    const exportData = isGrouped ? getGroupedAsistencias(filtered, tipoFilter) : filtered;
    const cols = getVisibleColumns(tableKey);
    const fechaInicio = document.getElementById('filterFechaInicio').value;
    const data = exportData.map(a => {
        const row = {};
        cols.forEach(c => { row[c.label] = c.renderExcel(a); });
        return row;
    });
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Asistencias');
    ws['!cols'] = cols.map(() => ({ wch: 18 }));
    XLSX.writeFile(wb, 'asistencias_' + fechaInicio + '.xlsx');
    showToast('Excel generado', 'success');
    logActivity('EXPORT', 'Export√≥ asistencias a Excel (' + exportData.length + ' registros)', 'asistencias');
}

async function downloadBackup() {
    showLoading(true);
    try {
        const [emp, att, pts] = await Promise.all([
            db.from('empleados').select('*'),
            db.from('asistencias').select('*'),
            db.from('qr_points').select('*')
        ]);
        const backup = {
            fecha: new Date().toISOString(),
            exportadoPor: state.currentUser?.nombre || 'Admin',
            trabajadores: emp.data || [],
            asistencias: att.data || [],
            puntos: pts.data || []
        };
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'backup_manuelita_' + getLocalDateString() + '.json';
        a.click(); URL.revokeObjectURL(url);
        showToast('Backup descargado', 'success');
        logActivity('EXPORT', 'Descarg√≥ backup JSON completo', 'configuracion');
    } catch (e) {
        showToast('Error al generar backup', 'error');
    } finally {
        showLoading(false);
    }
}

// =====================================================
// GPS UTILIDADES
// =====================================================
function usarMiUbicacionPunto() {
    if (!navigator.geolocation) { showToast('Geolocalizaci√≥n no soportada', 'error'); return; }
    showToast('Obteniendo ubicaci√≥n...', 'warning');
    navigator.geolocation.getCurrentPosition(
        function(position) {
            document.getElementById('inputPuntoLat').value = position.coords.latitude.toFixed(6);
            document.getElementById('inputPuntoLng').value = position.coords.longitude.toFixed(6);
            showToast('Ubicaci√≥n obtenida', 'success');
        },
        function(error) {
            let msg = 'Error obteniendo ubicaci√≥n';
            if (error.code === 1) msg = 'Permiso de ubicaci√≥n denegado';
            else if (error.code === 3) msg = 'Tiempo agotado obteniendo ubicaci√≥n';
            showToast('' + msg, 'error');
        },
        { enableHighAccuracy: true, timeout: 15000 }
    );
}

async function saveGpsConfig() {
    const enabled = document.getElementById('configGpsEnabled').checked;
    try {
        await db.from('system_config').upsert({ key: 'gps_enabled', value: enabled ? 'true' : 'false' });
        showToast(enabled ? 'GPS activado' : 'GPS desactivado', 'success');
        logActivity('CONFIG', enabled ? 'Activ√≥ verificaci√≥n GPS' : 'Desactiv√≥ verificaci√≥n GPS', 'configuracion');
    } catch (e) {
        showToast('Error guardando configuraci√≥n', 'error');
    }
}

async function loadGpsConfig() {
    try {
        const { data } = await db.from('system_config').select('value').eq('key', 'gps_enabled').maybeSingle();
        const enabled = data && data.value === 'true';
        document.getElementById('configGpsEnabled').checked = enabled;
    } catch (e) {
        document.getElementById('configGpsEnabled').checked = false;
    }
}

// =====================================================
// GR√ÅFICOS (CHART.JS)
// =====================================================
let chartAsistencia = null;
let chartTipos = null;

function initCharts() {
    const ctxAsistencia = document.getElementById('chartAsistencia').getContext('2d');
    const ctxTipos = document.getElementById('chartTipos').getContext('2d');

    // Gr√°fico de barras - Asistencia semanal
    chartAsistencia = new Chart(ctxAsistencia, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                { label: 'Entradas', data: [], backgroundColor: 'rgba(5, 150, 105, 0.8)', borderRadius: 4 },
                { label: 'Salidas', data: [], backgroundColor: 'rgba(2, 132, 199, 0.8)', borderRadius: 4 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });

    // Gr√°fico de dona - Distribuci√≥n Entrada/Salida
    chartTipos = new Chart(ctxTipos, {
        type: 'doughnut',
        data: {
            labels: ['Entradas', 'Salidas'],
            datasets: [{
                data: [0, 0],
                backgroundColor: ['rgba(5, 150, 105, 0.8)', 'rgba(2, 132, 199, 0.8)'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    updateCharts();
}

function updateCharts() {
    if (!chartAsistencia || !chartTipos) return;

    // Obtener √∫ltimos 7 d√≠as
    const dias = [];
    const labels = [];
    const entradas = [];
    const salidas = [];

    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const fecha = getLocalDateString(d);
        dias.push(fecha);
        labels.push(d.toLocaleDateString('es-PE', { weekday: 'short', day: 'numeric' }));
    }

    dias.forEach(fecha => {
        const dayRecords = state.asistencias.filter(a => a.fecha === fecha);
        entradas.push(dayRecords.filter(a => a.tipo === 'ENTRADA').length);
        salidas.push(dayRecords.filter(a => a.tipo === 'SALIDA').length);
    });

    // Actualizar gr√°fico de barras
    chartAsistencia.data.labels = labels;
    chartAsistencia.data.datasets[0].data = entradas;
    chartAsistencia.data.datasets[1].data = salidas;
    chartAsistencia.update();

    // Actualizar gr√°fico de dona (hoy)
    const today = getLocalDateString();
    const todayRecords = state.asistencias.filter(a => a.fecha === today);
    const totalEntradas = todayRecords.filter(a => a.tipo === 'ENTRADA').length;
    const totalSalidas = todayRecords.filter(a => a.tipo === 'SALIDA').length;
    chartTipos.data.datasets[0].data = [totalEntradas, totalSalidas];
    chartTipos.update();
}

// =====================================================
// UTILIDADES
// =====================================================
function updateDateTime() {
    document.getElementById('headerDatetime').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> ' + new Date().toLocaleDateString('es-PE', { weekday: 'short', day: 'numeric', month: 'short' }) + ' ‚Ä¢ ' + new Date().toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
}
function showLoading(show) { document.getElementById('loading').classList.toggle('show', show); }
function showToast(message, type) {
    const toast = document.getElementById('toast');
    const iconName = type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'alert-triangle';
    toast.innerHTML = '<i data-lucide="' + iconName + '" style="width:18px;height:18px"></i> ' + message;
    toast.className = 'toast ' + (type || 'success') + ' show';
    lucide.createIcons();
    setTimeout(() => toast.classList.remove('show'), 3000);
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModalTrabajador(); closeModalPunto(); closeModalUsuario(); closeColumnConfigModal(); } });

// =====================================================
// INICIALIZACI√ìN
// =====================================================
document.addEventListener('DOMContentLoaded', () => {
    initAuth();
    lucide.createIcons();
});
    </script>
</body>
</html>
