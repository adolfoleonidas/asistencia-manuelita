<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marcar Asistencia - Manuelita</title>
    <meta name="theme-color" content="#16a34a">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#16a34a;--primary-dark:#15803d;--primary-light:#dcfce7;--success:#059669;--success-light:#d1fae5;--info:#0284c7;--info-light:#e0f2fe;--warning:#d97706;--warning-light:#fef3c7;--error:#dc2626;--error-light:#fee2e2;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-400:#9ca3af;--gray-500:#6b7280;--gray-700:#374151;--gray-900:#111827;--radius:16px;--radius-sm:12px}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'Inter',-apple-system,sans-serif;background:var(--gray-100);color:var(--gray-900);min-height:100vh}
        .container{max-width:500px;margin:0 auto;padding:20px;padding-bottom:40px}
        .header{text-align:center;padding:32px 20px;background:#fff;border-radius:var(--radius);margin-bottom:20px;border:1px solid var(--gray-200);position:relative;overflow:hidden}
        .header::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--primary-dark))}
        .logo{width:80px;height:80px;border-radius:var(--radius-sm);object-fit:contain;margin:0 auto 16px;display:block;background:#fff;padding:8px;border:1px solid var(--gray-200)}
        .header h1{font-size:28px;font-weight:800;color:var(--primary)}
        .header>p{color:var(--gray-500);font-size:14px;margin-top:4px}
        .datetime{margin-top:16px;padding:12px 20px;background:var(--gray-50);border-radius:var(--radius-sm);font-size:14px;color:var(--gray-500)}
        .punto-badge{display:inline-flex;align-items:center;gap:8px;margin-top:12px;padding:8px 16px;background:var(--success-light);color:var(--success);border-radius:20px;font-size:13px;font-weight:600}
        .punto-badge .dot{width:8px;height:8px;background:var(--success);border-radius:50%;animation:pulse 2s infinite}
        .location-status{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:12px;padding:10px 16px;border-radius:var(--radius-sm);font-size:13px;font-weight:600}
        .location-status.checking{background:var(--warning-light);color:var(--warning)}
        .location-status.valid{background:var(--success-light);color:var(--success)}
        .location-status.invalid{background:var(--error-light);color:var(--error)}
        .spinner-small{width:16px;height:16px;border:2px solid currentColor;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
        .card{background:#fff;border-radius:var(--radius);border:1px solid var(--gray-200);overflow:hidden;margin-bottom:20px}
        .card-header{padding:20px;border-bottom:1px solid var(--gray-200);display:flex;align-items:center;gap:12px}
        .card-header-icon{width:44px;height:44px;background:var(--primary-light);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px}
        .card-header h2{font-size:18px;font-weight:700}
        .card-header p{font-size:13px;color:var(--gray-500)}
        .card-body{padding:24px}
        .blocked-screen{text-align:center;padding:40px 20px}
        .blocked-icon{width:100px;height:100px;background:var(--error-light);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;margin:0 auto 24px}
        .blocked-screen h2{font-size:22px;font-weight:700;color:var(--error);margin-bottom:12px}
        .blocked-screen>p{color:var(--gray-500);font-size:14px;line-height:1.6;margin-bottom:24px}
        .distance-info{background:var(--gray-50);padding:16px;border-radius:var(--radius-sm);margin-bottom:24px}
        .distance-info .label{font-size:12px;color:var(--gray-500);margin-bottom:4px}
        .distance-info .value{font-size:24px;font-weight:800;color:var(--error)}
        .distance-info .limit{font-size:13px;color:var(--gray-500);margin-top:4px}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;font-size:14px;font-weight:600;color:var(--gray-700);margin-bottom:8px}
        .form-group label span{color:var(--error)}
        .input{width:100%;padding:16px;border:2px solid var(--gray-200);border-radius:var(--radius-sm);font-family:inherit;font-size:16px;color:var(--gray-900);transition:all .2s;background:#fff}
        .input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px var(--primary-light)}
        .input::placeholder{color:var(--gray-400)}
        .btn{width:100%;padding:18px 24px;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:10px}
        .btn:disabled{opacity:.6;cursor:not-allowed}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover:not(:disabled){background:var(--primary-dark)}
        .btn-success{background:var(--success);color:#fff}
        .btn-outline{background:transparent;color:var(--primary);border:2px solid var(--primary)}
        .screen{display:none;animation:fadeIn .3s}
        .screen.active{display:block}
        .dni-display{text-align:center;padding:32px;background:var(--gray-50);border-radius:var(--radius-sm);margin-bottom:24px}
        .dni-value{font-size:42px;font-weight:800;color:var(--gray-900);letter-spacing:6px;font-family:monospace}
        .dni-placeholder{color:var(--gray-300)}
        .numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-width:320px;margin:0 auto}
        .numpad-btn{aspect-ratio:1.5;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:24px;font-weight:700;cursor:pointer;transition:all .15s;background:#fff;color:var(--gray-900);border:1px solid var(--gray-200)}
        .numpad-btn:hover{background:var(--gray-50)}
        .numpad-btn:active{transform:scale(.95);background:var(--primary-light)}
        .numpad-btn.action{background:var(--gray-50);font-size:18px}
        .numpad-btn.submit{background:var(--primary);color:#fff;border-color:var(--primary)}
        .numpad-btn.submit:disabled{background:var(--gray-200);border-color:var(--gray-200);color:var(--gray-400)}
        .success-screen{text-align:center;padding:40px 20px}
        .success-icon{width:100px;height:100px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;margin:0 auto 24px;animation:bounceIn .5s}
        .success-icon.entrada{background:var(--success-light)}
        .success-icon.salida{background:var(--info-light)}
        .success-title{font-size:28px;font-weight:800;margin-bottom:8px}
        .success-title.entrada{color:var(--success)}
        .success-title.salida{color:var(--info)}
        .success-time{font-size:48px;font-weight:800;color:var(--gray-900);margin:24px 0;font-family:monospace}
        .success-details{background:var(--gray-50);border-radius:var(--radius-sm);padding:20px;margin:24px 0;text-align:left}
        .success-detail{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--gray-200)}
        .success-detail:last-child{border-bottom:none}
        .success-detail label{color:var(--gray-500);font-size:14px}
        .success-detail span{font-weight:600;color:var(--gray-900)}
        .countdown{font-size:14px;color:var(--gray-500);margin-top:24px}
        .register-header{text-align:center;margin-bottom:24px}
        .register-header .icon{width:64px;height:64px;background:var(--warning-light);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 16px}
        .register-header h2{font-size:22px;font-weight:700;margin-bottom:8px}
        .register-header p{color:var(--gray-500);font-size:14px}
        .dni-readonly{background:var(--gray-50);font-weight:700;font-size:20px;text-align:center;letter-spacing:4px}
        .loading{display:none;position:fixed;inset:0;background:rgba(255,255,255,.95);z-index:1000;align-items:center;justify-content:center;flex-direction:column;gap:16px}
        .loading.show{display:flex}
        .spinner{width:50px;height:50px;border:4px solid var(--gray-200);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        .loading-text{font-size:16px;color:var(--gray-500);font-weight:500}
        .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);padding:16px 24px;border-radius:var(--radius-sm);font-size:14px;font-weight:600;z-index:2000;opacity:0;transition:all .3s;display:flex;align-items:center;gap:10px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
        .toast.success{background:var(--success);color:#fff}
        .toast.error{background:var(--error);color:#fff}
        .toast.warning{background:var(--warning);color:#fff}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
        @keyframes bounceIn{0%{transform:scale(0)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
        @keyframes spin{to{transform:rotate(360deg)}}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        @media(max-width:400px){.container{padding:12px}.header h1{font-size:24px}.dni-value{font-size:32px;letter-spacing:4px}.numpad-btn{font-size:20px}.success-time{font-size:36px}}
        .icon-lg{width:48px;height:48px}
        .icon-xl{width:64px;height:64px}
        .icon-sm{width:20px;height:20px}
        .icon-xs{width:16px;height:16px}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="https://mrqfeynhafxtfjqmjaxb.supabase.co/storage/v1/object/public/driver-images/drivers/1766979760638-y186di.jpg" alt="Manuelita" class="logo">
            <h1>MANUELITA</h1>
            <p>Control de Asistencia</p>
            <div class="datetime" id="datetime"></div>
            <div class="punto-badge"><span class="dot"></span><span id="puntoNombre">ENTRADA PRINCIPAL</span></div>
            <div class="location-status checking" id="locationStatus"><div class="spinner-small"></div><span>Verificando ubicación...</span></div>
        </header>

        <div class="screen" id="screenBlocked">
            <div class="card"><div class="card-body blocked-screen">
                <div class="blocked-icon"><i data-lucide="map-pin"></i></div>
                <h2>Fuera del área permitida</h2>
                <p>No puedes marcar asistencia porque no te encuentras dentro del área de la empresa.</p>
                <div class="distance-info">
                    <div class="label">Tu distancia actual</div>
                    <div class="value" id="currentDistance">0 metros</div>
                    <div class="limit">Máximo permitido: <span id="maxDistance">150</span> metros</div>
                </div>
                <button class="btn btn-primary" onclick="checkLocation()"><i data-lucide="refresh-cw" class="icon-sm"></i> Verificar de nuevo</button>
            </div></div>
        </div>

        <div class="screen" id="screenQuickMark">
            <div class="card"><div class="card-body" style="text-align:center;padding:40px 20px">
                <p style="font-size:16px;color:var(--gray-500);margin-bottom:8px" id="quickMarkGreeting">Buenos días</p>
                <div style="width:80px;height:80px;background:var(--primary-light);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px" id="quickMarkIcon"><i data-lucide="check-circle" style="width:48px;height:48px;color:var(--success)"></i></div>
                <h2 style="font-size:24px;font-weight:700;margin-bottom:4px" id="quickMarkNombre">-</h2>
                <p style="color:var(--gray-500);font-size:14px;margin-bottom:24px" id="quickMarkCargo">-</p>
                <button class="btn btn-primary" id="btnQuickMark" onclick="quickMark()" style="font-size:20px;padding:22px 24px"><span id="btnQuickMarkText">MARCAR ENTRADA</span> <i data-lucide="check-circle" class="icon-sm" id="btnQuickMarkIcon"></i></button>
                <div id="quickMarkHistory" style="margin-top:24px;text-align:left;background:var(--gray-50);border-radius:var(--radius-sm);padding:16px;display:none">
                    <p style="font-size:12px;font-weight:600;color:var(--gray-500);margin-bottom:12px;text-transform:uppercase">Últimas marcaciones</p>
                    <div id="quickMarkHistoryList"></div>
                </div>
                <p style="margin-top:20px;font-size:13px;color:var(--gray-400)"><a href="#" onclick="switchUser();return false" style="color:var(--gray-500);text-decoration:underline" id="switchUserLink">¿No eres este trabajador? Ingresa tu DNI</a></p>
            </div></div>
        </div>

        <div class="screen" id="screenAlreadyMarked">
            <div class="card"><div class="card-body" style="text-align:center;padding:40px 20px">
                <div style="width:100px;height:100px;background:var(--success-light);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px"><i data-lucide="check-circle" style="width:56px;height:56px;color:var(--success)"></i></div>
                <h2 style="font-size:22px;font-weight:700;color:var(--success);margin-bottom:8px">Ya marcaste hoy</h2>
                <p style="color:var(--gray-500);font-size:14px;margin-bottom:8px">Ya registraste entrada y salida hoy</p>
                <p style="font-size:18px;font-weight:700;margin-bottom:24px" id="alreadyMarkedNombre">-</p>
                <p style="font-size:13px;color:var(--gray-400)"><a href="#" onclick="switchUser();return false" style="color:var(--gray-500);text-decoration:underline" id="switchUserLinkAlready">¿No eres este trabajador? Ingresa tu DNI</a></p>
            </div></div>
        </div>

        <div class="screen" id="screenDni">
            <div class="card">
                <div class="card-header"><div class="card-header-icon"><i data-lucide="id-card" style="width:24px;height:24px;color:var(--primary)"></i></div><div><h2>Ingresa tu DNI</h2><p>8 dígitos para marcar asistencia</p></div></div>
                <div class="card-body">
                    <div class="dni-display"><div class="dni-value" id="dniDisplay"><span class="dni-placeholder">--------</span></div></div>
                    <div class="numpad">
                        <button class="numpad-btn" onclick="addDigit('1')">1</button>
                        <button class="numpad-btn" onclick="addDigit('2')">2</button>
                        <button class="numpad-btn" onclick="addDigit('3')">3</button>
                        <button class="numpad-btn" onclick="addDigit('4')">4</button>
                        <button class="numpad-btn" onclick="addDigit('5')">5</button>
                        <button class="numpad-btn" onclick="addDigit('6')">6</button>
                        <button class="numpad-btn" onclick="addDigit('7')">7</button>
                        <button class="numpad-btn" onclick="addDigit('8')">8</button>
                        <button class="numpad-btn" onclick="addDigit('9')">9</button>
                        <button class="numpad-btn action" onclick="clearDni()"><i data-lucide="delete" style="width:24px;height:24px"></i></button>
                        <button class="numpad-btn" onclick="addDigit('0')">0</button>
                        <button class="numpad-btn submit" id="btnSubmitDni" onclick="submitDni()" disabled>→</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen" id="screenRegister">
            <div class="card"><div class="card-body">
                <div class="register-header"><div class="icon"><i data-lucide="user-plus" style="width:32px;height:32px;color:var(--warning)"></i></div><h2>¡Bienvenido!</h2><p>Es tu primera vez, completa tus datos</p></div>
                <form id="registerForm" onsubmit="submitRegister(event)">
                    <div class="form-group"><label>DNI</label><input type="text" class="input dni-readonly" id="registerDni" readonly></div>
                    <div class="form-group"><label>Nombres y Apellidos <span>*</span></label><input type="text" class="input" id="registerNombre" placeholder="Ej: Juan Pérez" maxlength="200" required></div>
                    <div class="form-group"><label>Cargo <span>*</span></label><input type="text" class="input" id="registerCargo" placeholder="Ej: Operario" maxlength="100" required></div>
                    <div class="form-group"><label>Área <span>*</span></label><input type="text" class="input" id="registerArea" placeholder="Ej: Cosecha" maxlength="100" required></div>
                    <button type="submit" class="btn btn-success"><i data-lucide="user-check" class="icon-sm"></i> Registrarme y Marcar</button>
                    <button type="button" class="btn btn-outline" style="margin-top:12px" onclick="goBack()">← Volver</button>
                </form>
            </div></div>
        </div>

        <div class="screen" id="screenSuccess">
            <div class="card"><div class="card-body success-screen">
                <div class="success-icon" id="successIcon"><i data-lucide="check-circle" style="width:56px;height:56px"></i></div>
                <h2 class="success-title" id="successTitle">ENTRADA REGISTRADA</h2>
                <div class="success-time" id="successTime">08:30:45</div>
                <div class="success-details">
                    <div class="success-detail"><label>Empleado</label><span id="successNombre">-</span></div>
                    <div class="success-detail"><label>DNI</label><span id="successDni">-</span></div>
                    <div class="success-detail"><label>Cargo</label><span id="successCargo">-</span></div>
                    <div class="success-detail"><label>Punto</label><span id="successPunto">-</span></div>
                </div>
                <button class="btn btn-primary" onclick="resetApp()">✓ Listo</button>
                <div class="countdown">Volviendo en <span id="countdown">10</span>s...</div>
            </div></div>
        </div>
    </div>

    <div class="loading" id="loading"><div class="spinner"></div><div class="loading-text" id="loadingText">Cargando...</div></div>
    <div class="toast" id="toast"></div>

    <script>
// =====================================================
// ESTADO
// =====================================================
let PUNTOS = {};
let GPS_ENABLED = false;
let state = {
    dni: '',
    punto: 'ENTRADA_PRINCIPAL',
    employee: null,
    countdownTimer: null,
    countdownValue: 10,
    locationValid: false,
    userLocation: null,
    currentDistance: 0,
    quickMarkType: null
};

// =====================================================
// INICIALIZACIÓN
// =====================================================
document.addEventListener('DOMContentLoaded', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    state.punto = urlParams.get('punto') || 'ENTRADA_PRINCIPAL';
    document.getElementById('puntoNombre').textContent = state.punto.replace(/_/g, ' ');

    updateDateTime();
    setInterval(updateDateTime, 1000);

    const statusEl = document.getElementById('locationStatus');

    // Verificar configuración de Supabase
    if (!db) {
        statusEl.className = 'location-status invalid';
        statusEl.innerHTML = '<i data-lucide="x-circle" class="icon-xs"></i> Sistema no configurado';
        document.querySelector('#screenBlocked .blocked-screen h2').textContent = 'Sistema no configurado';
        document.querySelector('#screenBlocked .blocked-screen > p').textContent = 'El administrador debe configurar Supabase primero. Accede a admin.html para configurar las credenciales.';
        showScreen('screenBlocked');
        lucide.createIcons();
        return;
    }

    statusEl.className = 'location-status checking';
    statusEl.innerHTML = '<div class="spinner-small"></div><span>Cargando...</span>';

    // Cargar todo en paralelo para mayor velocidad
    const [configLoaded] = await Promise.all([
        loadConfig(),
        loadGpsConfig(),
        loadEmployeesCache()
    ]);

    if (!configLoaded || Object.keys(PUNTOS).length === 0) {
        statusEl.className = 'location-status invalid';
        statusEl.innerHTML = '<i data-lucide="x-circle" class="icon-xs"></i> Sin puntos';
        document.querySelector('#screenBlocked .blocked-screen h2').textContent = 'Sin configuración';
        document.querySelector('#screenBlocked .blocked-screen > p').textContent = 'No hay puntos de marcación configurados.';
        showScreen('screenBlocked');
        lucide.createIcons();
        return;
    }

    if (!PUNTOS[state.punto]) {
        statusEl.className = 'location-status invalid';
        statusEl.innerHTML = '<i data-lucide="x-circle" class="icon-xs"></i> Punto inválido';
        document.querySelector('#screenBlocked .blocked-screen h2').textContent = 'Punto no encontrado';
        document.querySelector('#screenBlocked .blocked-screen > p').textContent = 'El punto "' + state.punto.replace(/_/g, ' ') + '" no existe.';
        showScreen('screenBlocked');
        lucide.createIcons();
        return;
    }

    document.getElementById('puntoNombre').textContent = PUNTOS[state.punto].nombre || state.punto.replace(/_/g, ' ');
    document.getElementById('maxDistance').textContent = PUNTOS[state.punto].radio;

    if (GPS_ENABLED) {
        checkLocation();
    } else {
        statusEl.className = 'location-status valid';
        statusEl.innerHTML = '<i data-lucide="check-circle" class="icon-xs"></i> Listo';
        state.locationValid = true;
        onLocationValid();
    }
    lucide.createIcons();
});

async function loadGpsConfig() {
    try {
        const { data } = await db.from('system_config').select('value').eq('key', 'gps_enabled').maybeSingle();
        GPS_ENABLED = data && data.value === 'true';
    } catch (e) {
        GPS_ENABLED = false;
    }
}

async function loadConfig() {
    try {
        const { data, error } = await db.from('qr_points').select('*').eq('activo', true);
        if (error) throw error;
        if (data && data.length > 0) {
            PUNTOS = {};
            data.forEach(p => {
                PUNTOS[p.id] = { lat: p.lat, lng: p.lng, radio: p.radio, nombre: p.nombre };
            });
            return true;
        }
        return false;
    } catch (e) {
        console.error('Error cargando configuración:', e);
        return false;
    }
}

// =====================================================
// GEOLOCALIZACIÓN
// =====================================================
async function checkLocation() {
    const statusEl = document.getElementById('locationStatus');
    statusEl.className = 'location-status checking';
    statusEl.innerHTML = '<div class="spinner-small"></div><span>Verificando ubicación...</span>';

    if (!navigator.geolocation) {
        setStatusError(statusEl, 'Geolocalización no soportada', 'Geolocalización no disponible', 'Tu navegador no soporta geolocalización. Usa un navegador moderno como Chrome o Safari.');
        return;
    }

    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        setStatusError(statusEl, 'Se requiere HTTPS', 'Se requiere conexión segura', 'La geolocalización solo funciona con HTTPS.');
        return;
    }

    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            });
        });

        state.userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
        const ubicacion = PUNTOS[state.punto];

        if (!ubicacion || !ubicacion.lat || !ubicacion.lng) {
            setStatusError(statusEl, 'Sin coordenadas', 'Punto sin coordenadas', 'El punto no tiene coordenadas configuradas.');
            return;
        }

        const distance = calculateDistance(state.userLocation.lat, state.userLocation.lng, ubicacion.lat, ubicacion.lng);
        state.currentDistance = Math.round(distance);

        if (distance <= ubicacion.radio) {
            state.locationValid = true;
            statusEl.className = 'location-status valid';
            statusEl.innerHTML = '<i data-lucide="check-circle" class="icon-xs"></i> Ubicación verificada';
            lucide.createIcons();
            onLocationValid();
        } else {
            state.locationValid = false;
            statusEl.className = 'location-status invalid';
            statusEl.innerHTML = '<i data-lucide="x-circle" class="icon-xs"></i> Fuera del área';
            lucide.createIcons();
            document.getElementById('currentDistance').textContent = state.currentDistance + ' metros';
            showScreen('screenBlocked');
        }
    } catch (error) {
        let msg = 'Error de ubicación';
        let blockedTitle = 'Error de ubicación';
        let blockedMsg = 'No se pudo obtener tu ubicación. Intenta de nuevo.';

        if (error.code === 1) {
            msg = 'Permiso denegado';
            blockedTitle = 'Permiso de ubicación denegado';
            blockedMsg = 'Debes permitir el acceso a tu ubicación para marcar asistencia.';
        } else if (error.code === 2) {
            msg = 'Ubicación no disponible';
            blockedTitle = 'Ubicación no disponible';
            blockedMsg = 'No se pudo determinar tu ubicación. Asegúrate de tener el GPS activado.';
        } else if (error.code === 3) {
            msg = 'Tiempo agotado';
            blockedTitle = 'Tiempo de espera agotado';
            blockedMsg = 'La búsqueda de ubicación tardó demasiado.';
        }

        setStatusError(statusEl, msg, blockedTitle, blockedMsg);
        document.getElementById('currentDistance').textContent = 'No disponible';
        document.querySelector('#screenBlocked .blocked-screen h2').textContent = blockedTitle;
        document.querySelector('#screenBlocked .blocked-screen > p').textContent = blockedMsg;
        showScreen('screenBlocked');
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function setStatusError(statusEl, msg, title, desc) {
    statusEl.className = 'location-status invalid';
    statusEl.innerHTML = '<i data-lucide="x-circle" class="icon-xs"></i> ' + msg;
    document.querySelector('#screenBlocked .blocked-screen h2').textContent = title;
    document.querySelector('#screenBlocked .blocked-screen > p').textContent = desc;
    showScreen('screenBlocked');
    lucide.createIcons();
}

// =====================================================
// DNI INPUT
// =====================================================
function addDigit(d) {
    if (state.dni.length < 8) {
        state.dni += d;
        updateDniDisplay();
        if (navigator.vibrate) navigator.vibrate(30);
    }
}

function clearDni() {
    if (state.dni.length > 0) {
        state.dni = state.dni.slice(0, -1);
        updateDniDisplay();
    }
}

function updateDniDisplay() {
    const display = document.getElementById('dniDisplay');
    const btn = document.getElementById('btnSubmitDni');
    if (state.dni.length === 0) display.innerHTML = '<span class="dni-placeholder">--------</span>';
    else display.innerHTML = state.dni + '<span class="dni-placeholder">' + '\u2013'.repeat(8 - state.dni.length) + '</span>';
    btn.disabled = state.dni.length !== 8;
}

// =====================================================
// BUSCAR EMPLEADO
// =====================================================
async function submitDni() {
    if (state.dni.length !== 8 || !state.locationValid) return;
    showLoading(true, 'Buscando...');

    try {
        // Buscar en cache local primero
        let employees = JSON.parse(localStorage.getItem('employees_cache') || '[]');
        let employee = employees.find(e => e.dni === state.dni);

        if (!employee) {
            // Buscar en Supabase
            const { data } = await db.from('empleados').select('*');
            if (data) {
                employees = data;
                localStorage.setItem('employees_cache', JSON.stringify(employees));
                employee = employees.find(e => e.dni === state.dni);
            }
        }

        showLoading(false);

        if (employee) {
            state.employee = employee;
            await markAttendance(employee);
        } else {
            showScreen('screenRegister');
            document.getElementById('registerDni').value = state.dni;
        }
    } catch (e) {
        showLoading(false);
        showToast('Error de conexión', 'error');
    }
}

// =====================================================
// REGISTRO DE NUEVO EMPLEADO
// =====================================================
async function submitRegister(event) {
    event.preventDefault();
    if (!state.locationValid) return;

    const nombre = document.getElementById('registerNombre').value.trim();
    const cargo = document.getElementById('registerCargo').value.trim();
    const area = document.getElementById('registerArea').value.trim();

    if (!nombre || !cargo || !area) {
        showToast('Completa todos los campos', 'warning');
        return;
    }

    showLoading(true, 'Registrando...');

    try {
        const employee = {
            dni: state.dni.substring(0, 8),
            nombre: nombre.toUpperCase().substring(0, 200),
            cargo: cargo.toUpperCase().substring(0, 100),
            area: area.toUpperCase().substring(0, 100)
        };

        const { error } = await db.from('empleados').insert(employee);

        if (error) {
            showLoading(false);
            if (error.code === '23505') {
                showToast('El DNI ya existe', 'error');
            } else {
                showToast(error.message || 'Error al registrar', 'error');
            }
            return;
        }

        // Actualizar cache
        let employees = JSON.parse(localStorage.getItem('employees_cache') || '[]');
        employees.push(employee);
        localStorage.setItem('employees_cache', JSON.stringify(employees));
        localStorage.setItem('manuelita_worker_dni', state.dni);

        state.employee = employee;
        await markAttendance(employee);
    } catch (e) {
        showLoading(false);
        showToast('Error al registrar', 'error');
    }
}

// =====================================================
// UTILIDAD DE FECHA LOCAL
// =====================================================
function getLocalDateString(date = new Date()) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}

// =====================================================
// MARCAR ASISTENCIA
// =====================================================
async function markAttendance(employee) {
    showLoading(true, 'Marcando...');

    try {
        const now = new Date();
        const today = getLocalDateString(now);
        const time = now.toTimeString().split(' ')[0]; // Formato HH:MM:SS (8 chars)
        let tipo = 'ENTRADA';

        // Verificar registros de hoy
        try {
            const { data: todayRecords } = await db
                .from('asistencias')
                .select('*')
                .eq('dni', state.dni)
                .eq('fecha', today);

            if (todayRecords) {
                const hasEntrada = todayRecords.some(r => r.tipo === 'ENTRADA');
                const hasSalida = todayRecords.some(r => r.tipo === 'SALIDA');

                if (hasEntrada && hasSalida) {
                    showLoading(false);
                    showAlreadyMarked(employee);
                    return;
                }
                if (hasEntrada) tipo = 'SALIDA';
            }
        } catch (e) {}

        const record = {
            dni: (employee.dni || '').substring(0, 8),
            nombre: (employee.nombre || '').substring(0, 200),
            cargo: (employee.cargo || '').substring(0, 100),
            tipo,
            fecha: today,
            hora: time.substring(0, 8),
            punto: (state.punto || '').substring(0, 100),
            lat: state.userLocation?.lat || null,
            lng: state.userLocation?.lng || null
        };

        const { data, error } = await db.from('asistencias').insert(record).select().single();
        showLoading(false);

        if (error) {
            if (error.message && error.message.includes('ya registraste')) {
                showAlreadyMarked(employee);
            } else {
                showToast(error.message || 'Error al marcar', 'error');
            }
            return;
        }

        localStorage.setItem('manuelita_worker_dni', state.dni);
        showSuccess({ ...record, ...data });
    } catch (e) {
        showLoading(false);
        showToast('Error al marcar', 'error');
    }
}

// =====================================================
// PANTALLAS
// =====================================================
function showSuccess(record) {
    const isEntrada = record.tipo === 'ENTRADA';
    const iconEl = document.getElementById('successIcon');
    iconEl.className = 'success-icon ' + (isEntrada ? 'entrada' : 'salida');
    iconEl.innerHTML = '<i data-lucide="' + (isEntrada ? 'check-circle' : 'log-out') + '" style="width:56px;height:56px;color:' + (isEntrada ? 'var(--success)' : 'var(--info)') + '"></i>';
    document.getElementById('successTitle').className = 'success-title ' + (isEntrada ? 'entrada' : 'salida');
    document.getElementById('successTitle').textContent = record.tipo + ' REGISTRADA';
    document.getElementById('successTime').textContent = record.hora;
    document.getElementById('successNombre').textContent = record.nombre;
    document.getElementById('successDni').textContent = record.dni;
    document.getElementById('successCargo').textContent = record.cargo;
    document.getElementById('successPunto').textContent = state.punto.replace(/_/g, ' ');
    showScreen('screenSuccess');
    lucide.createIcons();
    if (navigator.vibrate) navigator.vibrate(isEntrada ? [200] : [100, 100, 100]);
    startCountdown();
}

function startCountdown() {
    state.countdownValue = 10;
    document.getElementById('countdown').textContent = state.countdownValue;
    state.countdownTimer = setInterval(() => {
        state.countdownValue--;
        document.getElementById('countdown').textContent = state.countdownValue;
        if (state.countdownValue <= 0) {
            clearInterval(state.countdownTimer);
            resetApp();
        }
    }, 1000);
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function goBack() { showScreen('screenDni'); }

function resetApp() {
    if (state.countdownTimer) clearInterval(state.countdownTimer);
    state.dni = '';
    state.employee = null;
    state.quickMarkType = null;
    updateDniDisplay();
    document.getElementById('registerForm').reset();

    if (GPS_ENABLED) {
        checkLocation();
    } else {
        state.locationValid = true;
        onLocationValid();
    }
}

// =====================================================
// QUICK MARK
// =====================================================
function onLocationValid() {
    const savedDni = localStorage.getItem('manuelita_worker_dni');
    if (savedDni && savedDni.length === 8) {
        tryQuickMark(savedDni);
    } else {
        showScreen('screenDni');
    }
}

async function tryQuickMark(dni) {
    showLoading(true, 'Verificando...');

    try {
        let employees = JSON.parse(localStorage.getItem('employees_cache') || '[]');
        let employee = employees.find(e => e.dni === dni);

        if (!employee) {
            const { data } = await db.from('empleados').select('*');
            if (data) {
                employees = data;
                localStorage.setItem('employees_cache', JSON.stringify(employees));
                employee = employees.find(e => e.dni === dni);
            }
        }

        if (!employee) {
            localStorage.removeItem('manuelita_worker_dni');
            showLoading(false);
            showScreen('screenDni');
            return;
        }

        state.dni = dni;
        state.employee = employee;

        const now = new Date();
        const today = getLocalDateString(now);
        let hasEntrada = false, hasSalida = false;

        try {
            const { data } = await db
                .from('asistencias')
                .select('*')
                .eq('dni', dni)
                .eq('fecha', today);

            if (data) {
                hasEntrada = data.some(r => r.tipo === 'ENTRADA');
                hasSalida = data.some(r => r.tipo === 'SALIDA');
            }
        } catch (e) {}

        showLoading(false);

        if (hasEntrada && hasSalida) showAlreadyMarked(employee);
        else if (hasEntrada) await showQuickMark(employee, 'SALIDA');
        else await showQuickMark(employee, 'ENTRADA');
    } catch (e) {
        showLoading(false);
        showScreen('screenDni');
    }
}

function getGreeting() {
    const hour = new Date().getHours();
    if (hour < 12) return 'Buenos días';
    if (hour < 18) return 'Buenas tardes';
    return 'Buenas noches';
}

async function loadEmployeeHistory(dni) {
    try {
        const { data } = await db.from('asistencias')
            .select('tipo, fecha, hora')
            .eq('dni', dni)
            .order('timestamp', { ascending: false })
            .limit(5);
        return data || [];
    } catch (e) {
        return [];
    }
}

async function showQuickMark(employee, tipo) {
    state.quickMarkType = tipo;

    // Saludo personalizado
    const firstName = employee.nombre.split(' ')[0];
    document.getElementById('quickMarkGreeting').textContent = getGreeting() + ', ' + firstName;
    document.getElementById('quickMarkNombre').textContent = employee.nombre;
    document.getElementById('quickMarkCargo').textContent = employee.cargo || '';

    const isEntrada = tipo === 'ENTRADA';
    const iconEl = document.getElementById('quickMarkIcon');
    iconEl.innerHTML = '<i data-lucide="' + (isEntrada ? 'log-in' : 'log-out') + '" style="width:48px;height:48px;color:' + (isEntrada ? 'var(--success)' : 'var(--info)') + '"></i>';
    iconEl.style.background = isEntrada ? 'var(--success-light)' : 'var(--info-light)';

    const btn = document.getElementById('btnQuickMark');
    btn.innerHTML = (isEntrada ? 'MARCAR ENTRADA ' : 'MARCAR SALIDA ') + '<i data-lucide="' + (isEntrada ? 'log-in' : 'log-out') + '" class="icon-sm"></i>';
    btn.className = isEntrada ? 'btn btn-primary' : 'btn btn-success';
    btn.style.fontSize = '20px';
    btn.style.padding = '22px 24px';
    document.getElementById('switchUserLink').textContent = '¿No eres ' + firstName + '? Cambiar';

    // Cargar historial
    const history = await loadEmployeeHistory(employee.dni);
    const historyContainer = document.getElementById('quickMarkHistory');
    const historyList = document.getElementById('quickMarkHistoryList');

    if (history.length > 0) {
        historyContainer.style.display = 'block';
        historyList.innerHTML = history.map(h => {
            const isEnt = h.tipo === 'ENTRADA';
            return '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--gray-200)">' +
                '<div style="display:flex;align-items:center;gap:8px">' +
                '<i data-lucide="' + (isEnt ? 'log-in' : 'log-out') + '" style="width:16px;height:16px;color:' + (isEnt ? 'var(--success)' : 'var(--info)') + '"></i>' +
                '<span style="font-size:13px;color:var(--gray-700)">' + escapeHtml(h.tipo) + '</span></div>' +
                '<span style="font-size:12px;color:var(--gray-500)">' + escapeHtml(h.fecha) + ' ' + escapeHtml(h.hora) + '</span></div>';
        }).join('');
    } else {
        historyContainer.style.display = 'none';
    }

    lucide.createIcons();
    showScreen('screenQuickMark');
}

function showAlreadyMarked(employee) {
    document.getElementById('alreadyMarkedNombre').textContent = employee.nombre;
    document.getElementById('switchUserLinkAlready').textContent = '¿No eres ' + employee.nombre + '? Ingresa tu DNI';
    showScreen('screenAlreadyMarked');
}

async function quickMark() {
    if (!state.employee || !state.locationValid) return;
    await markAttendance(state.employee);
}

function switchUser() {
    localStorage.removeItem('manuelita_worker_dni');
    state.dni = '';
    state.employee = null;
    state.quickMarkType = null;
    updateDniDisplay();
    showScreen('screenDni');
}

// =====================================================
// CACHE DE EMPLEADOS
// =====================================================
async function loadEmployeesCache() {
    try {
        const { data } = await db.from('empleados').select('*');
        if (data) localStorage.setItem('employees_cache', JSON.stringify(data));
    } catch (e) {}
}

// =====================================================
// UTILIDADES
// =====================================================
function updateDateTime() {
    document.getElementById('datetime').textContent = new Date().toLocaleString('es-PE', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showLoading(show, text) {
    document.getElementById('loadingText').textContent = text || 'Cargando...';
    document.getElementById('loading').classList.toggle('show', show);
}

function showToast(msg, type) {
    const t = document.getElementById('toast');
    t.className = 'toast ' + (type || 'success');
    const iconName = type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'alert-triangle';
    t.innerHTML = '<i data-lucide="' + iconName + '" class="icon-sm"></i> ' + msg;
    t.classList.add('show');
    lucide.createIcons();
    setTimeout(() => t.classList.remove('show'), 3000);
}

// Teclado físico
document.addEventListener('keydown', e => {
    if (document.getElementById('screenDni').classList.contains('active')) {
        if (e.key >= '0' && e.key <= '9') addDigit(e.key);
        else if (e.key === 'Backspace') clearDni();
        else if (e.key === 'Enter' && state.dni.length === 8) submitDni();
    }
});

// Inicializar iconos
lucide.createIcons();
    </script>
</body>
</html>
